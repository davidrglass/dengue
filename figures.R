##############################################################################
#
# Script: figures.R
# Project: Dengue
# Author: David Glass
# Date: 10-24-21
#
# This script takes in the integrated and clustered dataset and
# performs analyses and makes plots for publication
#
#
# Instructions:
# Update USER INPUTS with directory locations
# Run script
#   Different analysis and figures are subsetted under MAIN below.
#   Individual analyses and plots can be run, but there are some
#   dependencies on code run above, particularly MAIN to 
#   Figure 2 Acute
#
# Versions:
# R 3.6.3
# Rstudio 1.3.1093
# viridis 0.6.1
# ggrepel 0.9.1
# cutpointr 1.1.0
# MetaCyto 1.8.0
# ggbeeswarm 0.6.0
# ggpubr 0.6.0
# uwot 0.1.10
# pheatmap 1.0.12
# MASS 7.3.54
# tidyverse 1.3.1
# data.table 1.14.0
# 
##############################################################################



###### LIBRARIES ######

require(viridis)
require(ggrepel)
require(cutpointr)
require(MetaCyto)
require(ggbeeswarm)
require(ggpubr)
require(uwot)
require(pheatmap)
require(MASS)
require(tidyverse)
require(data.table)



##### INPUTS #####

path <- "~/Research/phd/dengue/"
# full_dat created by integrate_and_subsample.R
dat.path <- paste0(path, "tables/full_dat.csv")
images.path <- paste0(path, "images/main/")
# Cutoffs generated by this script
cutoffs.path <- paste0(path, "tables/marker_cutoffs.csv")
# severonly.csv placed by user
sd.meta.path <- paste0(path, "tables/severeonly.csv")
# exposure.csv placed by user
exposure.path <- paste0(path, "tables/exposure.csv")


factors <- c("sample_name", "type", "subtype", "population", "isotype", "patient", "adult",
             "plate","sample_number", "sex", "age", "status", "day", "cohort", "cell_count")
sample.factors <- setdiff(factors, c("type", "subtype", "population", "isotype"))
all.markers <- c("CD1c", "CD3", "CD4", "CD8", "CD11c", "CD14", "CD16", "CD19", "CD23", "CD24",
                 "CD25", "CD27", "CD32", "CD33", "CD38", "CD45", "CD45RA", "CD56", "CD64",
                 "CD69", "CD86", "CD123", "CD141", 'CD209', "CCR7", "CTLA_4", "FoxP3", "HLA_DR",
                 "IgA", "IgD", "IgG", "IgM", "Ki_67", "PD_1", "PD_L1", "TCRgd")
isotype.channels <- c("IgD", "IgM", "IgG", "IgA")
checkpoint <- c("CTLA_4", "PD_1", "PD_L1")
fc.receptors <- c("CD16", "CD23", "CD32", "CD64")
activation <- c("CD11c", "CD25", "CD38", "CD69", "CD86", "PD_1", "Ki_67", "HLA_DR")

isotypes <- c("IgD", "IgMD", "IgM", "IgG", "IgA", "ND")
isotype.colors <- magma(6) %>%
  rev() %>%
  setNames(isotypes)
isotype.colors["ND"] <- "#D1D2D4"
statuses <- c("C", "DF", "DWS", "SD", "Z")
status.colors <- c("#DEB7B4", "#FC7873", "#C72636", "#760C05", "#C795AA") %>%
  setNames(statuses)
subtypes <- c("B_Inexperienced", "B_Memory", "B_Plasma", "M_Basophil", "M_Monocyte", "M_cDC",
              "M_pDC", "NK", "T_CD4", "T_CD8", "T_DN")
subtype.colors <- c("#750EE3", "#CD2EE6", "#C4006F", "#6FD96D", "#AEDD92", "#D7C05B",
                    "#DCDC04", "#886659", "#64E6F7", "#53A6F5", "#2947F2") %>% 
  setNames(subtypes)
types <- c("B", "M", "NK", "T")
type.colors <- c("#AD3434", "#D2E396", "#886659", "#360BB8") %>%
  setNames(types)
div.palette <- colorRampPalette(rev(c("#0E525E", "#82DDB6", "#FFFAFA", "#CFC3E0", "#533560")))(21)
four.color.pal <- c("grey50", "#93E5AB", "#3278F0", "#78EDF5")



##### FUNCTIONS #####

subsampleWrapper <- function(tab, n.sample, by.col=NULL) {
  # Wrapper function for subsampling
  # Inputs:
  #   tab - a data.table
  #   n.sample - number of observations to sample, or if using by.col n.sample per level in by.col
  #   by.col - if equally subsampling by column, the column to subsample by; if NULL, random subsample
  # Outputs:
  #   subsampled data.table
  set.seed(666)
  if(is.null(by.col)) return(tab[, .SD[sample(.N, n.sample)]])
  return(tab[, .SD[sample(.N, n.sample)], by=eval(by.col)])
}


subsampleStatusAdult <- function(dt,
                                 n.cells=150000,
                                 separate.adults=F) {
  # Subsample cells by status, adult, equally subsampled by patient within those
  # Inputs:
  #   dt - data.table of single cell info to subsample
  #   n.cells - the number of total cells to subsample
  #   separate.adults - Logical. Should you equally subsample children and adults?
  # Outputs:
  #   Subsampled data.table equally by status and patient (within status)
  if (separate.adults) {
    patient.counts <- dt[, .N, by=.(status, adult, patient)] %>%
      .[, .N, by=.(status, adult)]
    n.status <- nrow(patient.counts)
    to.sample <- round(n.cells / n.status)
    subsampled <- dt[0]
    for (i in seq(n.status)) {
      subsampled <- dt[status==patient.counts[i, status] & adult==patient.counts[i, adult]] %>%
        subsampleWrapper(n.sample=round(to.sample/patient.counts[i, N]), by.col="patient") %>%
        rbind(subsampled)
    }
    return(subsampled)
  }
  patient.counts <- dt[, .N, by=.(status, patient)] %>%
    .[, .N, by=.(status)]
  n.status <- nrow(patient.counts)
  to.sample <- round(n.cells / n.status)
  subsampled <- dt[0]
  for (i in seq(n.status)) {
    subsampled <- dt[status==patient.counts[i, status]] %>%
      subsampleWrapper(n.sample=round(to.sample/patient.counts[i, N]), by.col="patient") %>%
      rbind(subsampled)
  }
  return(subsampled)
}


maxSubsample <- function(tab, n.sample, by.col) {
  # Wrapper function to sample up to n.sample rows per level.
  #   If a level has less than n.sample rows, function will take all rows from that level.
  # Inputs:
  #   tab - a data.table
  #   n.sample - number of observations to sample per by.col level
  #   by.col - the column with discrete variables to subsample by
  # Outputs:
  #   subsampled data.table
  set.seed(666)
  subsamp <- tab[0]
  for (value in tab[, unique(eval(parse(text=by.col)))]) {
    sample.number <- min(n.sample, nrow(tab[eval(parse(text=by.col))==value]))
    subsamp <- rbind(subsamp,
                     tab[eval(parse(text=by.col))==value, .SD[sample(.N, sample.number)]])
  }
  return(subsamp)
}



subsampleStatusSmall <- function(dt,
                                 n.cells=150000) {
  # Subsample cells by status, sampling from patients as evenly as possible given low cell counts in some patients
  # Inputs:
  #   dt - data.table of single cell info to subsample
  #   n.cells - the number of total cells to subsample
  # Outputs:
  #   Subsampled data.table equally by status and patient (within status)
  statuses <- unique(dt$status)
  to.sample <- round(n.cells / length(statuses))
  subsampled <- dt[0]
  for (i in seq(length(statuses))) {
    # Cell counts of patients of status i 
    patient.pool <- dt[status==statuses[i], .N, by=patient]
    status.to.sample <- to.sample
    per.patient.to.sample <- ceiling(status.to.sample/patient.pool[, .N])
    not.equalized <- any(patient.pool[, N]<per.patient.to.sample)
    while (not.equalized) {
      # Total number of cells contained in patients with insufficient cell counts
      n.cells.patients.short <- patient.pool[N<per.patient.to.sample, sum(N)]
      # Cell counts of patients of status i with enough cells
      patient.pool <- patient.pool[N>=per.patient.to.sample]
      status.to.sample <- status.to.sample - n.cells.patients.short
      # Per patient now reduces total cell numbers by n.cells.patient.shorts
      #  and divides by number of patients with sufficient counts
      per.patient.to.sample <- ceiling(status.to.sample/patient.pool[, .N])
      # Increasing the per.patient sample number may cause some patients
      #  to now have insufficient cell numbers
      not.equalized <- any(patient.pool[, N]<per.patient.to.sample)
    }
    subsampled <- dt[status==statuses[i]] %>%
      maxSubsample(n.sample=per.patient.to.sample, by.col="patient") %>%
      rbind(subsampled)
  }
  return(subsampled)
}


designateCutoffs <- function(dt=subsampleWrapper(dat, 500, "sample_name"),
                             co.path=cutoffs.path,
                             visualize=T,
                             ip=images.path,
                             dir="cutoffs/") {
  # Identify the cutoff points for each marker
  # Inputs:
  #   dt - data.table. Note all cells are plotted so subsample.
  #   co.path - directory path and file name of co.path
  #   visualize - logical, should cutoffs be plotted
  #   ip - character of images folder path
  #   dir - directory name for images
  # Outputs:
  #   csv file & data.table of marker name and cutoff value
  #   images of populations with cutoffs
  
  pa <- paste0(ip, dir)
  if (!dir.exists(pa)) dir.create(pa)
  
  # helper functions
  populateDT <- function(mar, co) {
    co.dt <- rbind(co.dt, data.table(marker=mar, cutoff=co))
  }
  
  visualizeThreshold <- function(marker, co) {
    if(!visualize) return()
    dt[, density:=getDensity(CD45, eval(parse(text=marker)), n=50), by=population]
    ggplot(dt, aes(CD45, eval(parse(text=marker)), color=density)) +
      geom_point(size=0.2) +
      theme_bw() +
      labs(x="CD45", y=marker) +
      geom_hline(yintercept=co, linetype="dashed") +
      scale_color_viridis() +
      theme(legend.position="none") +
      facet_wrap(~population, nrow=5)
    ggsave(paste0(pa, marker, ".png"), width=7, height=7)
  }
  
  co.dt <- data.table(marker=character(), cutoff=numeric())
  
  ## CCR7
  co <- cutpointr(dt[population %in% c("T_CD4_Naive", "T_CD4_EM")], CCR7, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CCR7", co)
  co.dt <- populateDT("CCR7", co)
  
  ## CD1c
  co <- cutpointr(dt[subtype %in% c("M_cDC", "NK")], CD1c, subtype)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD1c", co)
  co.dt <- populateDT("CD1c", co)
  
  ## CD4
  co <- cutpointr(dt[population %in% c("T_CD4_EM", "T_CD8_EM")], CD4, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD4", co)
  co.dt <- populateDT("CD4", co)
  
  ## CD8
  co <- cutpointr(dt[subtype %in% c("T_CD8", "T_CD4")], CD8, subtype)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD8", co)
  co.dt <- populateDT("CD8", co)
  
  ## CD11c
  co <- cutpointr(dt[population %in% c("B_EffectorMemory", "B_Transitional")], CD11c, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD11c", co)
  co.dt <- populateDT("CD11c", co)
  
  ## CD16
  co <- cutpointr(dt[population %in% c("M_Mono_CD14", "M_Mono_CD16")], CD16, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD16", co)
  co.dt <- populateDT("CD16", co)
  
  ## CD19
  co <- cutpointr(dt[population %in% c("B_Naive", "M_Mono_CD14")], CD19, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD19", co)
  co.dt <- populateDT("CD19", co)
  
  ## CD23
  set.seed(666)
  co <- findCutoff(dt[population %in% c("B_Naive"), CD23]) %>%
    round(3)
  visualizeThreshold("CD23", co)
  co.dt <- populateDT("CD23", co)
  
  # ## CD24
  # co <- cutpointr(dt[population %in% c("B_Transitional", "M_Mono_CD14")], CD24, population)$optimal_cutpoint %>%
  #   round(3)
  # visualizeThreshold("CD24", co)
  # co.dt <- populateDT("CD24", co)
  
  ## CD25
  co <- cutpointr(dt[population %in% c("T_Treg", "T_NKT")], CD25, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD25", co)
  co.dt <- populateDT("CD25", co)
  
  ## CD27
  co <- cutpointr(dt[population %in% c("B_Plasma", "M_Mono_CD14")], CD27, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD27", co)
  co.dt <- populateDT("CD27", co)
  
  ## CD32
  co <- cutpointr(dt[population %in% c("B_Transitional", "T_CD4_CM")], CD32, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD32", co)
  co.dt <- populateDT("CD32", co)
  
  ## CD33
  co <- cutpointr(dt[population %in% c("M_cDC2", "B_Naive")], CD33, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD33", co)
  co.dt <- populateDT("CD33", co)
  
  ## CD38
  set.seed(666)
  co <- findCutoff(dt[population %in% c("B_EffectorMemory"), CD38]) %>%
    round(3)
  visualizeThreshold("CD38", co)
  co.dt <- populateDT("CD38", co)
  
  ## CD45RA
  co <- cutpointr(dt[population %in% c("T_CD4_EMRA", "T_CD4_EM")], CD45RA, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD45RA", co)
  co.dt <- populateDT("CD45RA", co)
  
  ## CD56
  co <- cutpointr(dt[population %in% c("T_NKT", "T_CD8_EMRA")], CD56, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD56", co)
  co.dt <- populateDT("CD56", co)
  
  ## CD64
  co <- cutpointr(dt[population %in% c("M_Mono_DP", "B_Naive")], CD64, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CD64", co)
  co.dt <- populateDT("CD64", co)
  
  ## CD69
  set.seed(666)
  co <- findCutoff(dt[population %in% c("T_NKT"), CD69]) %>%
    round(3)
  visualizeThreshold("CD69", co)
  co.dt <- populateDT("CD69", co)
  
  ## CD86
  set.seed(666)
  co <- findCutoff(dt[population %in% c("T_CD8_EM"), CD86]) %>%
    round(3)
  visualizeThreshold("CD86", co)
  co.dt <- populateDT("CD86", co)
  
  ## CD141
  set.seed(666)
  co <- findCutoff(dt[population %in% c("M_pDC"), CD141]) %>%
    round(3)
  visualizeThreshold("CD141", co)
  co.dt <- populateDT("CD141", co)
  
  ## CD209
  set.seed(666)
  co <- findCutoff(dt[population %in% c("M_Mono_CD14"), CD209]) %>%
    round(3)
  visualizeThreshold("CD209", co)
  co.dt <- populateDT("CD209", co)
  
  ## CTLA-4
  co <- cutpointr(dt[population %in% c("T_Treg", "M_Mono_CD14")], CTLA_4, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("CTLA_4", co)
  co.dt <- populateDT("CTLA_4", co)
  
  ## HLA-DR
  co <- cutpointr(dt[population %in% c("B_cMemory", "T_CD4_EMRA")], HLA_DR, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("HLA_DR", co)
  co.dt <- populateDT("HLA_DR", co)
  
  ## Ki_67
  set.seed(666)
  co <- findCutoff(dt[population %in% c("T_CD8_EM"), Ki_67]) %>%
    round(3)
  visualizeThreshold("Ki_67", co)
  co.dt <- populateDT("Ki_67", co)
  
  ## PD_1
  set.seed(666)
  co <- findCutoff(dt[population %in% c("T_CD8_CM"), PD_1]) %>%
    round(3)
  visualizeThreshold("PD_1", co)
  co.dt <- populateDT("PD_1", co)
  
  ## PD_L1
  co <- cutpointr(dt[population %in% c("M_Mono_DP", "B_Plasma")], PD_L1, population)$optimal_cutpoint %>%
    round(3)
  visualizeThreshold("PD_L1", co)
  co.dt <- populateDT("PD_L1", co)
  
  fwrite(co.dt, co.path)
  return(co.dt)
}


getDensity <- function(x, y, ...) {
  # Returns the 2D density vector for two numeric vectors
  # Inputs:
  #   x, y - numeric vectors
  #   ... additional arguments passed onto kde2d (probably n, number of grid point in each direction)
  # Outputs:
  #   vector of density values
  dens <- MASS::kde2d(x, y, ...)
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  ii <- cbind(ix, iy)
  return(dens$z[ii])
}


generateLDA <- function(dt, markers, col) {
  # Generates LDA coordinates separating col
  # Inputs:
  #   dt - input data.table
  #   markers - feature columna names to use
  #   col - response column name to separate
  # Outputs:
  #   adds ld1 and ld2 to dt
  x <- as.matrix(dt[, markers, with=F])
  transform <- lda(x=x, grouping=droplevels(dt[[col]]))$scaling
  dt[, `:=`(ld1=x%*%transform[,1], ld2=x%*%transform[,2])]
  return(dt)
}


generateUMAP <- function(dt, markers, ...) {
  # Generates umap coordinates
  # Inputs:
  #   dt - data.table
  #   markers - markers used to generate the manifold
  #   ... extra arguments passed to uwot::umap
  # Outputs:
  #   dt with umap.1 and umap.2 columns
  set.seed(666)
  umap.out <- uwot::umap(dt[, markers, with=F], ...)
  dt[, `:=`(umap.1=umap.out[,1], umap.2=umap.out[,2])]
  return(dt)
}


printFigOneUMAP <- function(dt, ip=images.path, dir, ps=0.2, sc=subtype.colors) {
  # Prints umaps to png
  # Inputs:
  #   dt - data.table
  #   ip - images directory path
  #   dir - directory name
  #   ps - point size passed onto geom_point
  #   sc - named vector of subtype hex colors
  # Outputs:
  #   directory of pngs
  
  pa <- paste0(ip, dir)
  if (!dir.exists(pa)) dir.create(pa)
  min.x <- min(dt$umap.1) - 0.75
  max.x <- max(dt$umap.1) + 0.75
  min.y <- min(dt$umap.2) - 0.75
  max.y <- max(dt$umap.2) + 0.75
  
  ggplot(dt, aes(umap.1, umap.2)) +
    geom_density2d(color="grey40", bins=15) +
    geom_point(size=ps, aes(color=subtype)) +
    theme_bw() +
    scale_color_manual(values=sc) +
    xlim(min.x, max.x) +
    ylim(min.y, max.y) +
    labs(x=NULL, y=NULL) +
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          panel.border=element_blank(),
          axis.ticks=element_blank(),
          axis.text=element_blank(),
          legend.position="none")
  ggsave(paste0(pa, "subtype_umap.png"), width=10, height=10)
}


printFigOneSuppUMAP <- function(dt,
                                ip=images.path,
                                dir,
                                ps=0.2) {
  # Prints umaps to png
  # Inputs:
  #   dt - data.table
  #   ip - images directory path
  #   dir - directory name
  #   ps - point size passed onto geom_point
  # Outputs:
  #   directory of pngs
  
  pa <- paste0(ip, dir)
  if (!dir.exists(pa)) dir.create(pa)
  min.x <- min(dt$umap.1) - 0.75
  max.x <- max(dt$umap.1) + 0.75
  min.y <- min(dt$umap.2) - 0.75
  max.y <- max(dt$umap.2) + 0.75
  
  for (st in unique(dt$status)) {
    print(st)
    # colored by density
    ggplot(dt, aes(umap.1, umap.2)) +
      geom_density2d(color="grey40", bins=15) +
      geom_point(data=dt[status==st], size=ps, aes(color=getDensity(umap.1, umap.2, n=100))) +
      theme_bw() +
      scale_color_viridis(option="magma") +
      xlim(min.x, max.x) +
      ylim(min.y, max.y) +
      labs(x=NULL, y=NULL) +
      theme(panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),
            panel.border=element_blank(),
            axis.ticks=element_blank(),
            axis.text=element_blank(),
            legend.position="none")
    ggsave(paste0(pa, "dd_", st, "_umap.png"), width=6, height=6)
  }
}


replaceNAs <- function(tab) {
  # Replaces NAs with zeroes in a data.table
  # Inputs:
  #   tab - data.table
  # Outputs:
  #   tab - data.table
  for (i in seq(ncol(tab))) {
    set(tab, which(is.na(tab[[i]])), i, 0)
  }
  return(tab)
}


makeLineageHeatmap <- function(dt=subsampled,
                               lin.markers=lineage.markers,
                               ip=images.path,
                               sc=subtype.colors,
                               dir="figure_1/") {
  # Makes heatmaps for figure 2
  # Inputs:
  #   dt - equally subsampled data.table of expression data
  #   lin.markers - character vector of lineage markers
  #   ip - path to images directory
  #   sc - vector of subtype colors
  #   dir - directory name to be created
  # Outputs:
  #   eps files of heatmap
  
  pa <- paste0(ip, dir)
  if (!dir.exists(pa)) dir.create(pa)
  
  annotations <- dt[, .(subtype, population)] %>%
    .[0]
  for (pop in unique(dt$population)) {
    annotations <- dt[population==pop, .N, by=.(subtype, population)] %>%
      .[N==max(.[,N]), subtype] %>%
      data.table(subtype=., population=pop) %>%
      rbind(annotations)
  }
  
  ar <- data.frame(subtype=annotations$subtype, row.names=annotations$population)
  ann.colors <- list(subtype=sc)
  
  
  lin.medians <- dt[, lapply(.SD, median), .SDcols=lin.markers, by=population] %>%
    .[order(population)] %>%
    as.matrix(rownames="population")
  breaks <- seq(0, 1, by=0.05)
  
  setEPS()
  postscript(paste0(pa, "lineage.eps"), width=9, height=6)
  lineage.heatmap <- pheatmap(lin.medians,
                              col=inferno(21),
                              breaks=breaks,
                              annotation_row=ar,
                              border_color=NA,
                              angle_col="45",
                              annotation_colors=ann.colors)
  dev.off()
}


getPercents <- function(dt=dat, fa=sample.factors) {
  # Calculates proportion of populations
  # Inputs:
  #   dt - data.table
  #   fa - character vector of factors
  # Outputs:
  #  percents - data.table where rows are samples and columns are summary stats

  population.percents <- dt[, .N, by=.(population, sample_name)] %>%
    .[, P:=100*N/sum(N), by=sample_name] %>%
    .[, N:=NULL] %>%
    dcast(sample_name~population, value.var="P")
  
  percents <- population.percents %>%
    replaceNAs() %>%
    merge(unique(dt[, fa, with=F]), by="sample_name")
  
  return(percents)
}


getFractionalAbundances <- function(dt=dat, fa=sample.factors) {
  # Calculates percent of population per subtype and subtype per type
  # Inputs:
  #   dt - data.table
  #   fa - character vector of factors
  # Outputs:
  #  percents - data.table where rows are samples and columns are summary stats
  
  subtype.type.percents <- dt[, .N, by=.(type, subtype, sample_name)] %>%
    .[, P:=100*N/sum(N), by=.(sample_name, type)] %>%
    .[, N:=NULL] %>%
    dcast(sample_name~type+subtype, value.var="P") %>%
    .[, `:=`(NK_NK=NULL)]
  
  population.subtype.percents <- dt[, .N, by=.(subtype, population, sample_name)] %>%
    .[, P:=100*N/sum(N), by=.(sample_name, subtype)] %>%
    .[, N:=NULL] %>%
    dcast(sample_name~subtype+population, value.var="P") %>%
    .[, `:=`(M_pDC_M_pDC=NULL,
             M_Basophil_M_Basophil=NULL,
             B_Plasma_B_Plasma=NULL, 
             B_Inexperienced_B_Transitional=NULL,
             B_Memory_B_cMemory=NULL,
             M_cDC_M_cDC1=NULL)]
  
  percents <- subtype.type.percents %>%
    merge(population.subtype.percents, by="sample_name") %>%
    replaceNAs() %>%
    merge(unique(dt[, fa, with=F]), by="sample_name")
  
  return(percents)
}


getMarkerSummaries <- function(dt, markers, fa=sample.factors) {
  # Calculates mean expression by population
  # Inputs:
  #   dt - data.table - showing only one type
  # Outputs:
  #  marker.summaries - data.table of summary statistics
  population.means <- dt[, lapply(.SD, mean), .SDcols=markers, by=.(population, sample_name)] %>%
    dcast(sample_name~population, value.var=markers) %>%
    setnames(setdiff(colnames(.), "sample_name"), paste0("mean_", setdiff(colnames(.), "sample_name"))) %>%
    replaceNAs() %>%
    merge(unique(dt[, fa, with=F]), by="sample_name")
  
  return(population.means)
}


getIsotypeAbundances <- function(dt=dat[type=="B"], fa=sample.factors) {
  # Calculates percent of isotype per population
  # Inputs:
  #   dt - data.table
  #   fa - character vector of factors
  # Outputs:
  #  isotype.abundances - data.table where rows are samples and columns are summary stats
  isotype.abundances <- dt[, .N, by=.(isotype, population, sample_name)] %>%
    .[, P:=100*N/sum(N), by=.(sample_name, population)] %>%
    .[, N:=NULL] %>%
    dcast(sample_name~population+isotype, value.var="P") %>%
    .[, B_Plasma_log_IgG_IgA:=log2(B_Plasma_IgG/B_Plasma_IgA)] %>%
    replaceNAs() %>%
    merge(unique(dt[, fa, with=F]), by="sample_name")
  
  
  return(isotype.abundances)
}


getEffectSize <- function(x, y, hedge=T) {
  # Calculates Hedge's g or Cohen's d effect size
  # Inputs:
  #   x - a numeric vector
  #   y - a numeric vector
  #   hedge - logical, if tru calculate Hedge's g, if false, Cohen's d
  # Ouptut:
  #   the effect size
  x.mean <- mean(x)
  y.mean <- mean(y)
  x.sd <- sd(x)
  y.sd <- sd(y)
  x.n <- length(x) - 1
  y.n <- length(y) - 1
  if (hedge) pooled.sd <- sqrt((x.n*x.sd^2 + y.n*y.sd^2)/(x.n+y.n))
  else pooled.sd <- sqrt((x.sd^2+y.sd^2)/2)
  return((x.mean-y.mean)/pooled.sd)
}


calculateStats <- function(dt, columns, multiple.hypothesis=T, separate.adults=F, unique.cutoff=0) {
  # Calculates effect size and p value for pairwise comparisons of statuses
  # Effect size is calculated as mean(cohort1) - mean(cohort2) / sd(all.cohorts)
  # Inputs:
  #   dt - a data.table where rows are samples and columns features
  #   columns - a character vector of values to calcluate
  #   multiple.hypothesis - should fdr correction be applied to p values
  #   separate.adults - logical, should adult values be separated
  #   unique.cutoff - minimum number of unique values in dataset to consdier a feature
  # Outputs:
  #   stats.dt - a data.table of length columns
  columns <- dt[, lapply(.SD, function(x) length(unique(x))), .SDcols=columns] %>%
    melt() %>%
    .[value>=unique.cutoff, variable] %>%
    droplevels()
  stats.dt <- data.table(feature=columns,
                         c.df.effect=numeric(),
                         c.df.p.value=numeric(),
                         c.dws.effect=numeric(),
                         c.dws.p.value=numeric(),
                         c.sd.effect=numeric(),
                         c.sd.p.value=numeric(),
                         df.dws.effect=numeric(),
                         df.dws.p.value=numeric(),
                         df.sd.effect=numeric(),
                         df.sd.p.value=numeric(),
                         dws.sd.effect=numeric(),
                         dws.sd.p.value=numeric())
  if (separate.adults) {
    stats.dt <- rbind(stats.dt, stats.dt)
    stats.dt[, adult:=c(rep(T, nrow(stats.dt)/2),
                        rep(F, nrow(stats.dt)/2))]
    for(col in columns) {
      for (l in c(T,F)) {
        temp <- dt[adult==l]
        col.std.dev <- sd(temp[, eval(parse(text=col))])
        c.v <- temp[status=="C", eval(parse(text=col))]
        df.v <- temp[status=="DF", eval(parse(text=col))]
        dws.v <- temp[status=="DWS", eval(parse(text=col))]
        sd.v <- temp[status=="SD", eval(parse(text=col))]
        stats.dt[feature==col & adult==l, `:=`(c.df.effect=getEffectSize(c.v, df.v),
                                               c.df.p.value=wilcox.test(c.v, df.v)$p.value,
                                               c.dws.effect=getEffectSize(c.v, dws.v),
                                               c.dws.p.value=wilcox.test(c.v, dws.v)$p.value,
                                               c.sd.effect=getEffectSize(c.v, sd.v),
                                               c.sd.p.value=wilcox.test(c.v, sd.v)$p.value,
                                               df.dws.effect=getEffectSize(df.v, dws.v),
                                               df.dws.p.value=wilcox.test(df.v, dws.v)$p.value,
                                               df.sd.effect=getEffectSize(df.v, sd.v),
                                               df.sd.p.value=wilcox.test(df.v, sd.v)$p.value,
                                               dws.sd.effect=getEffectSize(dws.v, sd.v),
                                               dws.sd.p.value=wilcox.test(dws.v, sd.v)$p.value)]
      }
    }
  } else {
    for(col in columns) {
      col.std.dev <- sd(dt[, eval(parse(text=col))])
      c.v <- dt[status=="C", eval(parse(text=col))]
      df.v <- dt[status=="DF", eval(parse(text=col))]
      dws.v <- dt[status=="DWS", eval(parse(text=col))]
      sd.v <- dt[status=="SD", eval(parse(text=col))]
      stats.dt[feature==col, `:=`(c.df.effect=getEffectSize(c.v, df.v),
                                  c.df.p.value=wilcox.test(c.v, df.v)$p.value,
                                  c.dws.effect=getEffectSize(c.v, dws.v),
                                  c.dws.p.value=wilcox.test(c.v, dws.v)$p.value,
                                  c.sd.effect=getEffectSize(c.v, sd.v),
                                  c.sd.p.value=wilcox.test(c.v, sd.v)$p.value,
                                  df.dws.effect=getEffectSize(df.v, dws.v),
                                  df.dws.p.value=wilcox.test(df.v, dws.v)$p.value,
                                  df.sd.effect=getEffectSize(df.v, sd.v),
                                  df.sd.p.value=wilcox.test(df.v, sd.v)$p.value,
                                  dws.sd.effect=getEffectSize(dws.v, sd.v),
                                  dws.sd.p.value=wilcox.test(dws.v, sd.v)$p.value)]
    }
  }
  if(multiple.hypothesis)
    stats.dt[, `:=`(c.df.p.value=p.adjust(c.df.p.value, method="fdr"),
                    c.dws.p.value=p.adjust(c.dws.p.value, method="fdr"),
                    c.sd.p.value=p.adjust(c.sd.p.value, method="fdr"),
                    df.dws.p.value=p.adjust(df.dws.p.value, method="fdr"),
                    df.sd.p.value=p.adjust(df.sd.p.value, method="fdr"),
                    dws.sd.p.value=p.adjust(dws.sd.p.value, method="fdr"))]
  return(stats.dt)
}


getDStats <- function(ps=percent.stats, separate.adults=F) {
  # Reformats percent stats to only look at DF vs SD, DF v DWS, and DWS vs SD - also vs controls
  # Inputs:
  #   ps - data.table generated from calculateStats
  #   separate.adults - logical 
  # Outputs:
  #   data.table with columns feature, group1, group2, effect, p.value
  
  if (separate.adults) {
    d.effect <- ps[, .(feature, adult, c.df.effect, c.dws.effect, c.sd.effect,
                       df.sd.effect, df.dws.effect, dws.sd.effect)] %>%
      melt(id.vars=c("feature", "adult"), variable.name="comparison", value.name="effect")
    d.effect[comparison=="df.dws.effect", `:=`(group1="DF", group2="DWS")]
    d.effect[comparison=="df.sd.effect", `:=`(group1="DF", group2="SD")]
    d.effect[comparison=="dws.sd.effect", `:=`(group1="DWS", group2="SD")]
    d.effect[comparison=="c.df.effect", `:=`(group1="C", group2="DF")]
    d.effect[comparison=="c.dws.effect", `:=`(group1="C", group2="DWS")]
    d.effect[comparison=="c.sd.effect", `:=`(group1="C", group2="SD")]
    
    d.p.value <- ps[, .(feature, adult, c.df.p.value, c.dws.p.value, c.sd.p.value,
                        df.sd.p.value, df.dws.p.value, dws.sd.p.value)] %>%
      melt(id.vars=c("feature", "adult"), variable.name="comparison", value.name="p.value")
    d.p.value[comparison=="df.dws.p.value", `:=`(group1="DF", group2="DWS")]
    d.p.value[comparison=="df.sd.p.value", `:=`(group1="DF", group2="SD")]
    d.p.value[comparison=="dws.sd.p.value", `:=`(group1="DWS", group2="SD")]
    d.p.value[comparison=="c.df.p.value", `:=`(group1="C", group2="DF")]
    d.p.value[comparison=="c.dws.p.value", `:=`(group1="C", group2="DWS")]
    d.p.value[comparison=="c.sd.p.value", `:=`(group1="C", group2="SD")]
    
    d.stats <- merge(d.effect[,!"comparison"], d.p.value[,!"comparison"], by=c("feature", "adult", "group1", "group2")) %>%
      .[order(abs(effect), decreasing=T)]
    return(d.stats)
  }
  
  d.effect <- ps[, .(feature, c.df.effect, c.dws.effect, c.sd.effect,
                     df.sd.effect, df.dws.effect, dws.sd.effect)] %>%
    melt(id.vars="feature", variable.name="comparison", value.name="effect")
  d.effect[comparison=="df.dws.effect", `:=`(group1="DF", group2="DWS")]
  d.effect[comparison=="df.sd.effect", `:=`(group1="DF", group2="SD")]
  d.effect[comparison=="dws.sd.effect", `:=`(group1="DWS", group2="SD")]
  d.effect[comparison=="c.df.effect", `:=`(group1="C", group2="DF")]
  d.effect[comparison=="c.dws.effect", `:=`(group1="C", group2="DWS")]
  d.effect[comparison=="c.sd.effect", `:=`(group1="C", group2="SD")]
  
  d.p.value <- ps[, .(feature, c.df.p.value, c.dws.p.value, c.sd.p.value, 
                      df.sd.p.value, df.dws.p.value, dws.sd.p.value)] %>%
    melt(id.vars="feature", variable.name="comparison", value.name="p.value")
  d.p.value[comparison=="df.dws.p.value", `:=`(group1="DF", group2="DWS")]
  d.p.value[comparison=="df.sd.p.value", `:=`(group1="DF", group2="SD")]
  d.p.value[comparison=="dws.sd.p.value", `:=`(group1="DWS", group2="SD")]
  d.p.value[comparison=="c.df.p.value", `:=`(group1="C", group2="DF")]
  d.p.value[comparison=="c.dws.p.value", `:=`(group1="C", group2="DWS")]
  d.p.value[comparison=="c.sd.p.value", `:=`(group1="C", group2="SD")]
  
  d.stats <- merge(d.effect[,!"comparison"], d.p.value[,!"comparison"], by=c("feature", "group1", "group2")) %>%
    .[order(abs(effect), decreasing=T)]
  return(d.stats)
}


makeLogPlots <- function(dt, ip=images.path, stats, dir, cols, y.label=NULL) {
  # Makes bar plots of mean log2 difference
  # Inputs:
  #   dt - data.table of summary statistics
  #   ip - path to images directory
  #   dir - directory name
  pa <- paste0(ip, dir)
  if (!dir.exists(pa)) dir.create(pa)
  
  temp <-dt[, lapply(.SD, median), .SDcols=cols, by=status] %>%
    transpose(keep.names="feature", make.names="status") %>%
    .[, `:=`(df.dws=log2(DWS/DF), df.sd=log2(SD/DF), dws.sd=log2(SD/DWS), DF=NULL, DWS=NULL, SD=NULL)] %>%
    melt(id.vars="feature", variable.name="comparison", value.name="log")
  temp[comparison=="df.dws", `:=`(group1="DF", group2="DWS")]
  temp[comparison=="df.sd", `:=`(group1="DF", group2="SD")]
  temp[comparison=="dws.sd", `:=`(group1="DWS", group2="SD")]
  temp <- merge(temp, stats, all.x=T, by=c("feature", "group1", "group2")) %>%
    .[, sig:=T] %>%
    .[is.na(p.value), sig:=F]
  
  setorderv(temp, "log", order=1L)
  for (comp in unique(temp$comparison)) {
    order <- temp[comparison==comp, feature]
    temp[, feature:=factor(feature, order)]
    
    ggplot(temp[comparison==comp], aes(feature, log, fill=sig)) +
      geom_col() +
      theme_bw() +
      labs(x=NULL, y=paste0("Log2 ratio (", y.label, ")"), title=comp) +
      scale_fill_manual(values=c("grey70", "#187A7A")) +
      theme(axis.text.x=element_text(hjust=1, angle=45),
            axis.text=element_text(size=14),
            title=element_text(size=16),
            legend.position="none",
            panel.grid.major.x=element_blank(),
            panel.grid.minor.x=element_blank(),
            plot.margin=unit(c(0,0,0,1), "cm"))
    ggsave(paste0(pa, str_remove(comp, "\\."), ".eps"), width=8, height=4)
  }
}


makeBoxplots <- function(dt, stats, sc=status.colors, ip=paste0(images.path, "boxplots/"),
                         dir, separate.adults=F, y.lab=NULL) {
  # Makes boxplots of summary features by status
  # Inputs:
  #   dt - data.table of summary stats
  #   stats - data.table with feature, comparison, and p.value
  #   sc - named vector of status color hex codes
  #   ip - path to images directory
  #   dir - new directory name
  #   separate.adults - should adult/children facet be plotted?
  # Outputs:
  #   png files
  if (!dir.exists(ip)) dir.create(ip)
  pa <- paste0(ip, dir)
  if (!dir.exists(pa)) dir.create(pa)
  
  stats[p.value<0.05, p.symbol:="*"]
  stats[p.value<0.01, p.symbol:="**"]
  stats[p.value<0.001, p.symbol:="***"]
  
  for (col in unique(stats$feature)) {
    n.sig.cols <- stats[feature==col, .N]
    print(col)
    y.sd <- dt[, eval(parse(text=col))] %>%
      sd()
    y.min <- dt[, eval(parse(text=col))] %>%
      min()
    y.max <- dt[, eval(parse(text=col))] %>%
      max()
    if (separate.adults) {
      ggplot(dt, aes(status, eval(parse(text=col)))) +
        geom_boxplot(aes(fill=status), outlier.shape=NA) +
        geom_quasirandom(width=0.2) +
        labs(x="Status", title=col, y=y.lab) +
        ylim(c(y.min, y.max+n.sig.cols*y.sd)) +
        stat_pvalue_manual(data=stats[feature==col],
                           label="p.symbol",
                           y.position=y.max + y.sd/3,
                           step.increase=0.15,
                           size=10) +
        scale_fill_manual(values=sc) +
        theme_bw() +
        facet_wrap(~adult, nrow=2, labeller=as_labeller(c(`FALSE`="Child", `TRUE`="Adult"))) +
        theme(axis.text=element_text(size=14),
              axis.title=element_text(size=16),
              legend.position="none")
      ggsave(paste0(pa, col, ".eps"), height=8, width=3)
    } else {
      ggplot(dt, aes(status, eval(parse(text=col)))) +
        geom_boxplot(aes(fill=status), outlier.shape=NA) +
        geom_quasirandom(width=0.2) +
        labs(x="Status", title=col, y=y.lab) +
        ylim(c(y.min, y.max+n.sig.cols*y.sd)) +
        stat_pvalue_manual(data=stats[feature==col],
                           label="p.symbol",
                           y.position=y.max + y.sd/3,
                           step.increase=0.15,
                           size=10) +
        scale_fill_manual(values=sc) +
        theme_bw() +
        theme(axis.text=element_text(size=14),
              axis.title=element_text(size=16),
              legend.position="none")
      ggsave(paste0(pa, col, ".eps"), height=4, width=3)
    }
  }
} 


printLDASummary <- function(dt=lda.out, ip=paste0(images.path, "figure_1/"), fn="LDA_global_sig", sc=status.colors) {
  # Prints umaps to png
  # Inputs:
  #   dt - data.table
  #   ip - images directory path
  #   fn - filename
  #   sc - named vector of hex colors for status
  # Outputs:
  #   png
  
  means <- dt[, lapply(.SD, mean), .SDcols=c("ld1", "ld2"), by=status] 
  ggplot(dt, aes(ld1, ld2)) +
    stat_ellipse(aes(color=status)) +
    geom_point(color ="black", pch=21, size=2, aes(fill=status)) +
    # geom_point(data=means, shape=8, size=5, color="black") +
    theme_bw() +
    scale_color_manual(values=sc) +
    scale_fill_manual(values=sc) +
    labs(x=NULL, y=NULL) +
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          axis.ticks=element_blank(),
          axis.text=element_blank(),
          legend.position="none")
  ggsave(paste0(ip, fn, ".eps"), width=2, height=2)
}


calculateSDSubtypeStats <- function(dt, columns, multiple.hypothesis=F, unique.cutoff=0) {
  # Calculates effect size and p value for pairwise comparisons sd subtypes and other
  # Effect size is calculated as mean(cohort1) - mean(cohort2) / sd(all.cohorts)
  # Inputs:
  #   dt - a data.table where rows are samples and columns features
  #   columns - a character vector of values to calcluate
  #   multiple.hypothesis - should fdr correction be applied to p values
  #   unique.cutoff - minimum number of unique values in dataset to consdier a feature
  # Outputs:
  #   stats.dt - a data.table of length columns
  columns <- dt[, lapply(.SD, function(x) length(unique(x))), .SDcols=columns] %>%
    melt() %>%
    .[value>=unique.cutoff, variable] %>%
    droplevels()
  stats.dt <- data.table(feature=columns,
                         c.dhf.effect=numeric(),
                         c.dhf.p.value=numeric(),
                         c.oi.effect=numeric(),
                         c.oi.p.value=numeric(),
                         df.dhf.effect=numeric(),
                         df.dhf.p.value=numeric(),
                         df.oi.effect=numeric(),
                         df.oi.p.value=numeric(),
                         dws.dhf.effect=numeric(),
                         dws.dhf.p.value=numeric(),
                         dws.oi.effect=numeric(),
                         dws.oi.p.value=numeric(),
                         dhf.oi.effect=numeric(),
                         dhf.oi.p.value=numeric())
  
  for(col in columns) {
    col.std.dev <- sd(dt[, eval(parse(text=col))])
    c.v <- dt[status=="C", eval(parse(text=col))]
    df.v <- dt[status=="DF", eval(parse(text=col))]
    dws.v <- dt[status=="DWS", eval(parse(text=col))]
    dhf.v <- dt[status=="DHF", eval(parse(text=col))]
    oi.v <- dt[status=="OI", eval(parse(text=col))]
    stats.dt[feature==col, `:=`(c.dhf.effect=getEffectSize(c.v, dhf.v),
                                c.dhf.p.value=wilcox.test(c.v, dhf.v)$p.value,
                                c.oi.effect=getEffectSize(c.v, oi.v),
                                c.oi.p.value=wilcox.test(c.v, oi.v)$p.value,
                                df.dhf.effect=getEffectSize(df.v, dhf.v),
                                df.dhf.p.value=wilcox.test(df.v, dhf.v)$p.value,
                                df.oi.effect=getEffectSize(df.v, oi.v),
                                df.oi.p.value=wilcox.test(df.v, oi.v)$p.value,
                                dws.dhf.effect=getEffectSize(dws.v, dhf.v),
                                dws.dhf.p.value=wilcox.test(dws.v, dhf.v)$p.value,
                                dws.oi.effect=getEffectSize(dws.v, oi.v),
                                dws.oi.p.value=wilcox.test(dws.v, oi.v)$p.value,
                                dhf.oi.effect=getEffectSize(dhf.v, oi.v),
                                dhf.oi.p.value=wilcox.test(dhf.v, oi.v)$p.value)]
  }
  
  if(multiple.hypothesis)
    stats.dt[, `:=`(c.dhf.p.value=p.adjust(c.dhf.p.value, method="fdr"),
                    c.oi.p.value=p.adjust(c.oi.p.value, method="fdr"),
                    df.dhf.p.value=p.adjust(df.dhf.p.value, method="fdr"),
                    df.oi.p.value=p.adjust(df.oi.p.value, method="fdr"),
                    dws.dhf.p.value=p.adjust(dws.dhf.p.value, method="fdr"),
                    dws.oi.p.value=p.adjust(dws.oi.p.value, method="fdr"),
                    dhf.oi.p.value=p.adjust(dhf.oi.p.value, method="fdr"))]
  return(stats.dt)
}


getSDStats <- function(ps=sd.stats) {
  # Melts stats table for ggpubr friendly format
  # Inputs:
  #   ps - data.table generated from calculateStats
  # Outputs:
  #   data.table with columns feature, group1, group2, effect, p.value
  
  d.effect <- ps[, .(feature, c.dhf.effect, c.oi.effect, df.dhf.effect, df.oi.effect,
                     dws.dhf.effect, dws.oi.effect, dhf.oi.effect)] %>%
    melt(id.vars="feature", variable.name="comparison", value.name="effect")
  d.effect[comparison=="c.dhf.effect", `:=`(group1="C", group2="DHF")]
  d.effect[comparison=="c.oi.effect", `:=`(group1="C", group2="OI")]
  d.effect[comparison=="df.dhf.effect", `:=`(group1="DF", group2="DHF")]
  d.effect[comparison=="df.oi.effect", `:=`(group1="DF", group2="OI")]
  d.effect[comparison=="dws.dhf.effect", `:=`(group1="DWS", group2="DHF")]
  d.effect[comparison=="dws.oi.effect", `:=`(group1="DWS", group2="OI")]
  d.effect[comparison=="dhf.oi.effect", `:=`(group1="DHF", group2="OI")]
  
  d.p.value <- ps[, .(feature, c.dhf.p.value, c.oi.p.value, df.dhf.p.value, df.oi.p.value,
                      dws.dhf.p.value, dws.oi.p.value, dhf.oi.p.value)] %>%
    melt(id.vars="feature", variable.name="comparison", value.name="p.value")
  d.p.value[comparison=="c.dhf.p.value", `:=`(group1="C", group2="DHF")]
  d.p.value[comparison=="c.oi.p.value", `:=`(group1="C", group2="OI")]
  d.p.value[comparison=="df.dhf.p.value", `:=`(group1="DF", group2="DHF")]
  d.p.value[comparison=="df.oi.p.value", `:=`(group1="DF", group2="OI")]
  d.p.value[comparison=="dws.dhf.p.value", `:=`(group1="DWS", group2="DHF")]
  d.p.value[comparison=="dws.oi.p.value", `:=`(group1="DWS", group2="OI")]
  d.p.value[comparison=="dhf.oi.p.value", `:=`(group1="DHF", group2="OI")]
  
  d.stats <- merge(d.effect[,!"comparison"], d.p.value[,!"comparison"], by=c("feature", "group1", "group2")) %>%
    .[order(abs(effect), decreasing=T)]
  return(d.stats)
}



##### MAIN ######

if (!dir.exists(images.path)) dir.create(images.path)

dat <- fread(dat.path, stringsAsFactors=T) %>%
  .[, isotype:=factor(isotype, names(isotype.colors))] %>%
  .[, cell_count:=.N, by=sample_name] %>%
  .[, adult:=T]
levels(dat$status) <- names(status.colors)
dat[is.na(day), day:=-2]
dat[age<17, adult:=F]

### Identify cutoffs
cutoffs <- designateCutoffs()
cutoffs <- fread(cutoffs.path)

##### Figure 1 summaries #####

subsampled <- subsampleStatusAdult(dat[!status %in% c("Z", "C") & cell_count>3000 & day<12 & sample_number %in% c(0,1)])
subsampled <- generateLDA(dt=subsampled, markers=all.markers, col="subtype")
subsampled <- generateUMAP(subsampled,
                           all.markers,
                           n_neighbors=15L,
                           min_dist=0.7,
                           init=as.matrix(subsampled[, .(ld1, ld2)]))

printFigOneUMAP(dt=subsampled,
                dir="figure_1/")
printFigOneSuppUMAP(dt=subsampled,
                    dir="figure_1/")


lineage.markers <- setdiff(all.markers,
                           c("CD45", "CD32", "CD64", "Ki_67", "PD_1", "PD_L1", "CD86", "CD69","CD209",
                             "IgM", "IgD", "IgA", "IgG", "CD23", "CTLA_4"))
makeLineageHeatmap()

### Exposure S1A

exp.table <- fread(exposure.path)
temp <- dat[!status %in% c("Z", "C") & cell_count>3000, .(patient, status)] %>%
  unique() %>%
  merge(exp.table, all.x=T, by="patient")
temp[exposure=="", exposure:="Unknown"]
ggplot(temp, aes(status, fill=exposure)) +
  geom_bar() +
  theme_bw() +
  labs(y="Patients", x=NULL, title="Exposure")
ggsave(paste0(images.path, "figure_1/patient_exposure.eps"), width=3, height=2.5)


##### Feature generation #####

### Summary of abundances
percents <- getPercents()
fwrite(percents, paste0(path, "tables/features_global_abundance.csv"))

### Summary of fractional abundances
fractions <- getFractionalAbundances()
fwrite(fractions, paste0(path, "tables/features_global_fractions.csv"))

### Myeloid
# For dropped UMAP analysis
m.markers <- setdiff(all.markers, c("CCR7", "CD3", "CD8", "CD19", "CD24", 
                                    "CD27", "CD32", "CD56", "CTLA_4", "FoxP3", 
                                    isotype.channels, "PD_1", "TCRgd"))
# Used in model
m.markers.lite <- setdiff(m.markers, c("CD1c", "CD4", "CD11c", "CD14", "CD16",
                                       "CD23", "CD25", "CD45", "CD69", "CD86", "CD123"))
m.marker.summaries <- getMarkerSummaries(dt=dat[type=="M"], markers=m.markers.lite)

m.marker.summaries  <- dat[subtype=="M_Monocyte", lapply(.SD, mean), .SDcols=m.markers.lite, by=.(sample_name)] %>%
  setnames(setdiff(colnames(.), "sample_name"), paste0("mean_", setdiff(colnames(.), "sample_name"), "_M_Monocyte")) %>%
  replaceNAs() %>%
  merge(m.marker.summaries, by="sample_name")

fwrite(m.marker.summaries, paste0(path, "tables/features_myeloid.csv"))


### NK cells
nk.markers <- setdiff(all.markers, c("CCR7", "CD1c", "CD3", "CD4", "CD14", "CD19",
                                     "CD23", "CD24", "CD27", "CD32", "CD33", "CD45",
                                     "CD64", "CD86", "CD123", "CD141", "CD209", "CTLA_4",
                                     "FoxP3", "TCRgd", isotype.channels))
nk.markers.lite <- setdiff(nk.markers, c("CD8"))
n.marker.summaries <- getMarkerSummaries(dt=dat[type=="NK"], markers=nk.markers.lite)

n.marker.summaries  <- dat[type=="NK", lapply(.SD, mean), .SDcols=nk.markers, by=.(sample_name)] %>%
  setnames(setdiff(colnames(.), "sample_name"), paste0("mean_", setdiff(colnames(.), "sample_name"), "_NK")) %>%
  replaceNAs() %>%
  merge(n.marker.summaries, by="sample_name")

fwrite(n.marker.summaries, paste0(path, "tables/features_nk.csv"))

### T CELLS
t.markers <- setdiff(all.markers, c("CD1c", "CD11c", "CD14", "CD19", "CD23", "CD24", "CD32", "CD33", "CD45", "CD64", "CD86",
                                     "CD123", "CD141", "CD209", isotype.channels))
t.markers.lite <- setdiff(t.markers, c("CD3", "CD4", "CD8", "CD16", "CD25", "CD45RA", "CD56", "CD69", "FoxP3", "TCRgd"))
t.marker.summaries <- getMarkerSummaries(dt=dat[type=="T"], markers=t.markers.lite)
fwrite(t.marker.summaries, paste0(path, "tables/features_t.csv"))

### B CELLS

b.markers <- setdiff(all.markers, c("CD3", "CD4", "CD8", "CD14", "CD16", "CD33", "CD45", "CD56",
                                    "CD64", "CD69", "CD86", "CD123", "CD141", "CD209", "PD_1", "FoxP3", "TCRgd"))
b.markers.lite <- setdiff(b.markers, c("CD11c", "CD19", "CD24", "CD27", isotype.channels))
b.marker.summaries <- getMarkerSummaries(dt=dat[type=="B"], markers=b.markers.lite)
fwrite(b.marker.summaries, paste0(path, "tables/features_b.csv"))

### Isotype abundances
isotype.abundances <- getIsotypeAbundances()
fwrite(isotype.abundances, paste0(path, "tables/features_isotype.csv"))

feature.table <- fread(paste0(path, "tables/features_global_abundance.csv"), stringsAsFactors=T) %>%
  merge(fread(paste0(path, "tables/features_global_fractions.csv"), stringsAsFactors=T), by=sample.factors) %>%
  merge(fread(paste0(path, "tables/features_myeloid.csv"), stringsAsFactors=T), by=sample.factors) %>%
  merge(fread(paste0(path, "tables/features_nk.csv"), stringsAsFactors=T), by=sample.factors) %>%
  merge(fread(paste0(path, "tables/features_t.csv"), stringsAsFactors=T), by=sample.factors) %>%
  merge(fread(paste0(path, "tables/features_b.csv"), stringsAsFactors=T), by=sample.factors) %>%
  merge(fread(paste0(path, "tables/features_isotype.csv"), stringsAsFactors=T), by=sample.factors)

ft.lite <- feature.table[day<12 & status!="Z" & cell_count>3000 & sample_number %in% c(0,1)]

##### Statistics #####

all.stats <- calculateStats(dt=ft.lite,
                            columns=setdiff(colnames(feature.table), factors))
d.all.stats <- getDStats(ps=all.stats)

### Log plot

### Figure 1F
makeLogPlots(dt=percents[day<12 & !status %in% c("Z", "C") & cell_count>3000 & sample_number %in% c(0,1)],
             stats=d.all.stats[p.value<0.05 & abs(effect)>0.5],
             dir="figure_one/",
             y.label="% of CD45+",
             cols=setdiff(colnames(percents), factors))

d.all.stats[p.value<0.05 & abs(effect)>0.5, p.symbol:="*"]
d.all.stats[p.value<0.01 & abs(effect)>0.5, p.symbol:="**"]
d.all.stats[p.value<0.001 & abs(effect)>0.5, p.symbol:="***"]
setorder(d.all.stats, p.value, effect)
fwrite(d.all.stats, paste0(path, "tables/acute_infection_stats.csv"))

sig.all.features <- d.all.stats[p.value<0.05 & abs(effect)>0.5 & group1!="C", feature] %>%
  unique() %>%
  as.character()

all.features <- unique(d.all.stats$feature)

### Fig 1E
lda.out <- generateLDA(dt=ft.lite,
                       markers=sig.all.features,
                       col="status")
printLDASummary(fn="LDA_global_sig")

ft.lite[, `:=`(ld1=NULL, ld2=NULL)]


##### Figure 2 acute + supplement #####

pa <- paste0(images.path, "figure_2/")
if (!dir.exists(pa)) dir.create(pa)

### Plasma abundance

ggplot(ft.lite, aes(status, B_Plasma)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="Plasma cells") +
  theme(legend.position="none") +
  ylim(0, 40) +
  stat_pvalue_manual(data=d.all.stats[feature=="B_Plasma" & p.value<0.05],
                     label="p.symbol",
                     y.position=25,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Plasma_box.eps"), height=2.5, width=2.5)

# B plasma Ki-67
ggplot(ft.lite, aes(status, mean_Ki_67_B_Plasma)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  ylim(0, 0.75) +
  labs(x=NULL, y="Mean Ki-67", title="Plasma cells") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=d.all.stats[feature=="mean_Ki_67_B_Plasma" & p.value<0.05],
                     label="p.symbol",
                     y.position=0.6,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Plasma_ki67_box.eps"), height=2.5, width=2.5)

### CD8 TEMRA supp
ggplot(ft.lite, aes(status, T_CD8_EMRA)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="CD8+ TEMRA") +
  theme(legend.position="none") +
  #ylim(0, 40) +
  stat_pvalue_manual(data=d.all.stats[feature=="T_CD8_EMRA" & p.value<0.05],
                     label="p.symbol",
                     y.position=25,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "CD8_TEMRA_box.eps"), height=2.5, width=2.5)


### Plasma IgG IgA Ratio
stats <- d.all.stats[feature=="B_Plasma_log_IgG_IgA" & p.value<0.05]
stats[p.value<0.05, p.symbol:="*"]
stats[p.value<0.01, p.symbol:="**"]
stats[p.value<0.001, p.symbol:="***"]

temp <- ft.lite[, .(B_Plasma_log_IgG_IgA, status)] %>%
  .[, `:=`(mean=mean(B_Plasma_log_IgG_IgA), se=sd(B_Plasma_log_IgG_IgA)/sqrt(.N)), by=status] %>%
  .[, .(status, mean, se)] %>%
  unique()

ggplot(temp, aes(status, mean)) +
  geom_col(aes(fill=status)) +
  labs(x=NULL, y="Log2 ratio (IgG/IgA)", title="Plasma cells") +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.3) +
  scale_fill_manual(values=status.colors) +
  stat_pvalue_manual(data=stats,
                     label="p.symbol",
                     y.position=2.65,
                     step.increase=0.1,
                     size=8) +
  scale_y_continuous(limits=c(-1.5, 3.15)) +
  theme_bw() +
  theme(legend.position="none")
ggsave(paste0(pa, "Plasma_ratio.eps"), width=2.5, height=2.5)

### Ki-67 percent positive
ki.co <- cutoffs[marker=="Ki_67", cutoff]
temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day<12 & sample_number %in% c(0,1)] %>%
  .[, .N, by=.(patient, status, population, Ki_67>ki.co)] %>%
  .[, P:=N*100/sum(N), by=.(patient, status, population)] %>%
  .[Ki_67==F] %>%
  .[, `:=`(P=100-P, N=NULL, Ki_67=NULL)]
population.order <- temp[status=="SD", median(P), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

ggplot(temp, aes(population, P, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Percent", title="% Ki-67+") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "ki_67_population_boxplot.eps"), width=10, height=3)


### Ki-67 mean

temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day<12 & sample_number %in% c(0,1)] %>%
  .[, mean(Ki_67), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- sig.all.features[grep("Ki_67", sig.all.features)]
p.values <- d.all.stats[group1=="DF" & group2=="SD" & feature %in% temp.features] %>%
  .[, population:=substring(feature, 12)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="Ki-67 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  ylim(0, .55) +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.5,
                     remove.bracket=T,
                     size=8) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "Ki_67_mean_population_boxplot.eps"), width=9, height=3)

### CD38 mean

temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day<12 & sample_number %in% c(0,1)] %>%
  .[, mean(CD38), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- sig.all.features[grep("CD38", sig.all.features)] %>%
  setdiff("mean_CD38_M_Monocyte")
p.values <- d.all.stats[group1=="DF" & group2=="SD" & feature %in% temp.features] %>%
  .[, population:=substring(feature, 11)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="CD38 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.9,
                     remove.bracket=T,
                     size=5) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "CD38_population_boxplot.eps"), width=10, height=3)
  
# Treg abundance
ggplot(ft.lite, aes(status, T_Treg)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="Tregs") +
  theme(legend.position="none") +
  ylim(0, 2) +
  stat_pvalue_manual(data=d.all.stats[feature=="T_Treg" & p.value<0.05],
                     label="p.symbol",
                     y.position=1.5,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Treg_box.eps"), height=2.5, width=2.5)

### Treg CD38

ggplot(ft.lite, aes(status, mean_CD38_T_Treg)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="Tregs") +
  theme(legend.position="none") +
  #ylim(0, 2) +
  stat_pvalue_manual(data=d.all.stats[feature=="mean_CD38_T_Treg" & p.value<0.05],
                     label="p.symbol",
                     y.position=0.65,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Treg_CD38_box.eps"), height=2.5, width=2.5)

### Treg proportions
n.sample <- dat[population=="T_Treg" & status=="C", .N] * 4
subsampled <- subsampleStatusSmall(dat[!status %in% c("Z") & cell_count>3000 & day<12 &
                                         sample_number %in% c(0,1) & population=="T_Treg"],
                                   n.cells=n.sample)
 
 ctla.co <- cutoffs[marker=="CTLA_4", cutoff]
 pd1.co <- cutoffs[marker=="PD_1", cutoff]
 temp <- subsampled[, .N, by=.(status, CTLA_4>ctla.co, PD_1>pd1.co)] %>%
   .[, P:=100*N/sum(N), by=status] %>%
   .[, N:=NULL]
 temp[, pattern:="DN"]
 temp[(CTLA_4), pattern:="CTLA_4"]
 temp[(PD_1), pattern:="PD_1"]
 temp[CTLA_4 & PD_1, pattern:="DP"]
 temp[, pattern:=factor(pattern, c("DP", "CTLA_4", "PD_1", "DN"))]
 
 color.pal <- four.color.pal %>%
   setNames(rev(levels(temp$pattern)))
 ggplot(temp, aes(status, P, fill=pattern)) +
   geom_col(position="stack") +
   theme_bw() +
   theme(panel.grid=element_blank(),
         legend.position="none") +
   scale_fill_manual(values=color.pal) +
   labs(y="Percent", title="Tregs")
 ggsave(paste0(pa, "treg_proportions.eps"), width=2.5, height=2.5)

 ### Treg CD38 vs CTLA-4
 
cor.out <-  cor.test(ft.lite$mean_CD38_T_Treg, ft.lite$mean_CTLA_4_T_Treg)
r.value <- cor.out$estimate %>%
  round(2)
p.value <- cor.out$p.value %>%
  signif(3)

ggplot(ft.lite, aes(mean_CD38_T_Treg, mean_CTLA_4_T_Treg)) +
  geom_point(aes(color=status)) +
  geom_smooth(method="lm", color="black", linetype="dashed", alpha=1) +
  theme_bw() + 
  scale_color_manual(values=status.colors) +
  labs(x="Mean CD38", y="Mean CTLA-4", title="Tregs") +
  theme(legend.position="none") +
  annotate(geom="text", x=0.1, y=0.8, label=paste0("r=", r.value)) +
  annotate(geom="text", x=0.1, y=0.7, label=paste0("p=", p.value))
ggsave(paste0(pa, "Treg_mean_biaxial.eps"), width=2.5, height=2.5)


### T cell correlations

t.pops <- dat[type=="T", unique(population)] %>%
  as.character()
expression.terms <- paste0("mean_", c("CD38", "CTLA_4", "Ki_67", "PD_1"), "_")
features <- c("CD38.CTLA_4", "CD38.Ki_67", "CD38.PD_1", "CTLA_4.Ki_67", "CTLA_4.PD_1", "Ki_67.PD_1")
t.cor <- data.table(population=character(),
                    feature=character(),
                    feature_1=character(),
                    feature_2=character(),
                    r=numeric(),
                    p.value=numeric())
for (pop in t.pops) {
  temp <- paste0(expression.terms, pop) %>%
    combn(2) %>%
    t() %>%
    as.data.table() %>%
    setnames(c("feature_1", "feature_2")) %>%
    .[, `:=`(population=pop, feature=features)]
  for (i in seq(features)) {
    feature.1.values <- ft.lite[[temp$feature_1[i]]]
    feature.2.values <- ft.lite[[temp$feature_2[i]]]
    cor.out <- cor.test(feature.1.values, feature.2.values)
    temp[i, `:=`(r=cor.out$estimate, p.value=cor.out$p.value)]
  }
  t.cor <- rbind(t.cor, temp)
}

t.cor[, r:=signif(r, 2)]
t.cor[, p.value:=p.adjust(p.value, method="fdr")]
t.cor[, p.value:=signif(p.value, 3)]
setorder(t.cor, p.value)
t.cor[p.value<0.05, signif:=T]

t.cor.matrix <- dcast(t.cor, population~feature, value.var="r") %>%
  as.matrix(rownames="population")
pop.order <- rowMeans(t.cor.matrix) %>%
  sort() %>%
  names() %>%
  rev()
t.cor.matrix <- t.cor.matrix[pop.order,]

range(t.cor.matrix)
my.breaks <- seq(0, 0.9, length.out=22)

setEPS()
postscript(paste0(pa, "t_correlations.eps"), width=6, height=3)
pheatmap(t(t.cor.matrix),
         cluster_cols=F,
         color=viridis(22),
         breaks=my.breaks,
         main="Pearson Correlation",
         angle_col=45)
dev.off()

t.cor[, mean(r), by=feature]


#### Checkpoint boxplots

# PD-L1
temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day<12 & sample_number %in% c(0,1)] %>%
  .[, mean(PD_L1), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- sig.all.features[grep("PD_L1", sig.all.features)] %>%
  setdiff("mean_PD_L1_NK")
p.values <- d.all.stats[group1=="DF" & group2=="SD" & feature %in% temp.features] %>%
  .[, population:=substring(feature, 12)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="PD-L1 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.65,
                     remove.bracket=T,
                     size=8) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "PDL1_population_boxplot.eps"), width=9, height=3)

# CTLA-4
temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day<12 & sample_number %in% c(0,1) & type=="T"] %>%
  .[, mean(CTLA_4), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- sig.all.features[grep("CTLA_4_T", sig.all.features)]
p.values <- d.all.stats[group1=="DF" & group2=="SD" & feature %in% temp.features] %>%
  .[, population:=substring(feature, 13)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="CTLA-4 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.95,
                     remove.bracket=T,
                     size=8) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "CTLA4_population_boxplot.eps"), width=4.5, height=3)

#### T cell PD-1

temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day<12 & sample_number %in% c(0,1) & type=="T"] %>%
  .[, mean(PD_1), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- sig.all.features[grep("PD_1_T", sig.all.features)]
p.values <- d.all.stats[group1=="DF" & group2=="SD" & feature %in% temp.features] %>%
  .[, population:=substring(feature, 11)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  scale_y_continuous(limits=c(0, 0.45)) +
  labs(x=NULL, y="Mean expression", title="PD-1 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.45,
                     remove.bracket=T,
                     size=5) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "PD1_population_boxplot.eps"), width=6, height=3)


##### Figure 3 acute + supplement #####

pa <- paste0(images.path, "figure_3/")
if (!dir.exists(pa)) dir.create(pa)

# cDC2 CD64 boxplot

ggplot(ft.lite, aes(status, mean_CD64_M_cDC2)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="Mean CD64", title="cDC2") +
  theme(legend.position="none") +
  ylim(0.15, 1.3) +
  stat_pvalue_manual(data=d.all.stats[feature=="mean_CD64_M_cDC2" & p.value<0.05],
                     label="p.symbol",
                     y.position=0.9,
                     step.increase=0.15,
                     size=10)
ggsave(paste0(pa, "mean_CD64_M_cDC2_box.eps"), height=2.5, width=2.5)

# cDC2 / cDC boxplot

ggplot(ft.lite, aes(status, M_cDC_M_cDC2)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of cDC", title="cDC2") +
  theme(legend.position="none") +
  ylim(23, 122) +
  stat_pvalue_manual(data=d.all.stats[feature=="M_cDC_M_cDC2" & p.value<0.05],
                     label="p.symbol",
                     y.position=103,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "M_cDC2_box.eps"), height=2.5, width=2.5)

### HLA_DR boxplots
temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day<12 &
              sample_number %in% c(0,1) & type %in% c("M", "NK") & population!="M_Basophil"] %>%
  .[, mean(HLA_DR), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]
setorder(temp, population)

temp.features <- sig.all.features[grep("HLA_", sig.all.features)]
p.values <- d.all.stats[group1=="DF" & group2=="SD" & feature %in% temp.features] %>%
  .[, population:=substring(feature, 13)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="HLA_DR") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  ylim(0, 0.92) +
  stat_pvalue_manual(data=p.values[!is.na(population)],
                     label="p.symbol",
                     x="population",
                     y.position=0.87,
                     remove.bracket=T,
                     size=8) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "HLA_DR_population_boxplot.eps"), width=4.5, height=3)


### cDC2 IgG CD64
igg.co <- 0.15
n.sample <- dat[population=="M_cDC2" & status=="DF", .N] * 4
subsampled <- subsampleStatusSmall(dat[!status %in% c("Z") & cell_count>3000 & day<12 &
                                         sample_number %in% c(0,1) & population=="M_cDC2"],
                                   n.cells=n.sample)
cd64.co <- cutoffs[marker=="CD64", cutoff]
subsampled[, `:=`(CD64.pos=CD64>cd64.co, IgG.pos=IgG>igg.co)]

cor.table <- data.table(status=statuses[1:4], cor=numeric(), p.value=numeric())
for (i in 1:4) {
  cor.out <- cor.test(subsampled[status==statuses[i], CD64], subsampled[status==statuses[i], IgG])
  cor.table[status==statuses[i], `:=`(cor=cor.out$estimate, p.value=cor.out$p.value)]
}


extra <- subsampled[, .N, by=.(status, IgG.pos, CD64.pos)] %>%
  .[, P:=100*N/sum(N), by=status]

subsampled[, density:=getDensity(IgG, CD64, n=100), by=status]
ggplot(subsampled, aes(IgG, CD64)) +
  geom_point(size=0.2, aes(color=density)) +
  geom_hline(yintercept=cd64.co, linetype="dashed") +
  geom_vline(xintercept=igg.co, linetype="dashed") +
  geom_label(data=extra[IgG.pos==T & CD64.pos==T], aes(x=0.75, y=1.1, label=paste0(round(P, 2), "%"))) +
  geom_label(data=extra[IgG.pos==F & CD64.pos==T], aes(x=0.1, y=1.1, label=paste0(round(P, 2), "%"))) +
  theme_bw() +
  facet_wrap(~status) +
  scale_color_viridis() +
  theme(legend.position="none")
ggsave(paste0(pa, "cDC2_CD64_IgG.png"), width=5, height=5)

melted <- subsampled[status=="SD", .SD, .SDcols=c("CD64", isotype.channels)] %>%
  melt(id.vars="CD64", variable.name="Isotype", value.name="Ig")
r.values <- melted[, cor(CD64, Ig, method="pearson"), by=Isotype]

melted[, density:=getDensity(Ig, CD64, n=100), by=Isotype]
ggplot(melted, aes(Ig, CD64)) +
  geom_point(size=0.2, aes(color=density)) +
  theme_bw() +
  facet_wrap(~Isotype) +
  scale_color_viridis() +
  theme(legend.position="none")
ggsave(paste0(pa, "cDC2_CD64_IgAll.png"), width=5, height=5)


### Monocytes IgG CD64

subsampled <- subsampleWrapper(dat[day<12 & status!="Z" & cell_count>3000 & 
                                     sample_number %in% c(0,1) & subtype=="M_Monocyte"], 10000, by.col="status")
cd64.co <- cutoffs[marker=="CD64", cutoff]
subsampled[, `:=`(CD64.pos=CD64>cd64.co, IgG.pos=IgG>igg.co)]

cor.table <- data.table(status=statuses[1:4], cor=numeric(), p.value=numeric())
for (i in 1:4) {
  cor.out <- cor.test(subsampled[status==statuses[i], CD64], subsampled[status==statuses[i], IgG])
  cor.table[status==statuses[i], `:=`(cor=cor.out$estimate, p.value=cor.out$p.value)]
}

extra <- subsampled[, .N, by=.(status, IgG.pos, CD64.pos)] %>%
  .[, P:=100*N/sum(N), by=status]

subsampled[, density:=getDensity(IgG, CD64, n=100), by=status]
ggplot(subsampled, aes(IgG, CD64)) +
  geom_point(size=0.2, aes(color=density)) +
  geom_hline(yintercept=cd64.co, linetype="dashed") +
  geom_vline(xintercept=igg.co, linetype="dashed") +
  geom_label(data=extra[IgG.pos==T & CD64.pos==T], aes(x=0.75, y=1.1, label=paste0(round(P, 2), "%"))) +
  geom_label(data=extra[IgG.pos==F & CD64.pos==T], aes(x=0.1, y=1.1, label=paste0(round(P, 2), "%"))) +
  theme_bw() +
  facet_wrap(~status) +
  scale_color_viridis() +
  theme(legend.position="none")
ggsave(paste0(pa, "Monocytes_CD64_IgG.png"), width=5, height=5)

mono.features <- paste0("M_Monocyte_M_Mono_", c("DN", "DP", "CD14", "CD16"))

temp <- ft.lite[status %in% c("DF", "SD"), c(mono.features, "status"), with=F] %>%
  melt(id.vars="status", variable.name="population", value.name="P") %>%
  .[, `:=`(median=median(P)), by=.(status, population)] %>%
  .[, .(status, population, median)] %>%
  unique() %>%
  dcast(population~status, value.var="median") %>%
  .[, ratio:=SD-DF] %>%
  .[, sig:=F] %>%
  .[population=="M_Monocyte_M_Mono_CD16", sig:=T] %>%
  .[, population:=substring(population, 14)] %>%
  .[, population:=factor(population, population[c(1,3,4,2)])]

ggplot(temp, aes(population, ratio, fill=sig)) +
  geom_col() +
  labs(x=NULL, y="Median SD - median DF", title="% of Monocytes") +
  scale_fill_manual(values=c("grey70", "#187A7A")) +
  theme_bw() +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "Mono_bar_trends.eps"), width=2.5, height=2.7)


correlation.table <- data.table(mar=all.markers, C=numeric(), DF=numeric(), DWS=numeric(), SD=numeric())
for (marker in all.markers) {
  cors <- subsampled[, cor(CD141, eval(parse(text=marker))), by=status]
  correlation.table[mar==marker, `:=`(C=cors[status=="C", V1],
                                      DF=cors[status=="DF", V1],
                                      DWS=cors[status=="DWS", V1],
                                      SD=cors[status=="SD", V1])]
}

### DF SD Comparison heatmap

markers <- c("HLA_DR", "CD64", "CD38", "Ki_67", "PD_L1", "CD209", "CD141")
pops <- c("M_cDC1", "M_cDC2", "M_pDC", "M_Mono_CD14", "M_Mono_CD16", "M_Mono_DP", "M_Mono_DN")
features <- expand.grid(markers, pops) %>%
  apply(1, paste, collapse="_") %>%
  paste0("mean_", .)

myeloid.compare.dt <- ft.lite[status %in% c("DF", "SD"), c("status", features), with=F] %>%
  .[, lapply(.SD, median), by=status] %>%
  melt(id.vars="status", variable.name="feature") %>%
  dcast(feature~status) %>%
  .[, dif:=SD-DF] %>%
  merge(all.stats[, .(feature, df.sd.p.value)], all.x=T, by="feature") %>%
  cbind(as.data.table(expand.grid(markers, pops))) %>%
  .[, `:=`(SD=NULL, DF=NULL, feature=NULL)]
setnames(myeloid.compare.dt, c("Var1", "Var2"), c("marker", "population"))

differences <- myeloid.compare.dt[, !"df.sd.p.value"] %>%
  dcast(population~marker, value.var="dif") %>%
  as.matrix(rownames="population") %>%
  t()

breaks <- max(abs(range(differences))) %>%
  seq(-., ., length.out=22)

setEPS()
postscript(paste0(pa, "heatmap_D_SD_differences.eps"), width=3.5, height=3)
pheatmap(mat=differences, color=div.palette, breaks=breaks, angle_col=45)
dev.off()


### CD64 correlation analysis cDC2

ft.correlation <- dat[day<12 & status!="Z" & cell_count>3000 & sample_number %in% c(0,1) & population=="M_cDC2"] %>%
  .[, mean(IgG), by=patient] %>%
  setnames("V1", "mean_IgG_M_cDC2") %>%
  merge(ft.lite, by="patient")

ft.correlation <- dat[day<12 & status!="Z" & cell_count>3000 & sample_number %in% c(0,1) & subtype=="M_Monocyte"] %>%
  .[, mean(IgG), by=patient] %>%
  setnames("V1", "mean_IgG_M_Monocyte") %>%
  merge(ft.correlation, by="patient")

features <- grep("cDC2", colnames(ft.correlation), value=T) %>%
  grep("mean", x=., value=T)

cor.table <- data.table(feature1=numeric(),
                        feature2=numeric(),
                        cor=numeric(),
                        p.value=numeric())
combos <- combn(features, 2)
for (i in seq(ncol(combos))) {
  cor.out <- cor.test(ft.correlation[[combos[1,i]]], ft.correlation[[combos[2,i]]])
  cor.table <- data.table(feature1=combos[1,i],
                          feature2=combos[2,i],
                          cor=cor.out$estimate,
                          p.value=cor.out$p.value) %>%
    rbind(cor.table)
}
setorder(cor.table, p.value)

r.value <- cor.table[feature1=="mean_IgG_M_cDC2" & feature2=="mean_CD64_M_cDC2", cor] %>%
  round(2)
p.value <- cor.table[feature1=="mean_IgG_M_cDC2" & feature2=="mean_CD64_M_cDC2", p.value] %>%
  signif(3)

ggplot(ft.correlation, aes(mean_IgG_M_cDC2, mean_CD64_M_cDC2)) +
  geom_smooth(method="lm", color="black", linetype="dashed", alpha=1) +
  geom_point(aes(color=status)) +
  theme_bw() + 
  scale_color_manual(values=status.colors) +
  labs(x="Mean IgG", y="Mean CD64", title="cDC2") +
  theme(legend.position="none") +
  annotate(geom="text", x=0.1, y=1, label=paste0("r=", r.value)) +
  annotate(geom="text", x=0.1, y=0.9, label=paste0("p=", p.value))
ggsave(paste0(pa, "cDC2_mean_biaxial.eps"), width=2.5, height=2.5)

cor.out <- cor.test(ft.correlation[["mean_IgG_M_Monocyte"]], ft.correlation[["mean_CD64_M_Monocyte"]])

r.value <- cor.out$estimate %>%
  round(2)
p.value <- cor.out$p.value %>%
  signif(3)

ggplot(ft.correlation, aes(mean_IgG_M_Monocyte, mean_CD64_M_Monocyte)) +
  geom_smooth(method="lm", color="black", linetype="dashed", alpha=1) +
  geom_point(aes(color=status)) +
  theme_bw() + 
  scale_color_manual(values=status.colors) +
  labs(x="Mean IgG", y="Mean CD64", title="Monocytes") +
  theme(legend.position="none") +
  annotate(geom="text", x=0.1, y=1, label=paste0("r=", r.value)) +
  annotate(geom="text", x=0.1, y=0.9, label=paste0("p=", p.value))
ggsave(paste0(pa, "Monocyte_mean_biaxial.eps"), width=2.5, height=2.5)


##### Figure 2-3 convalescent + supplement #####

pa <- paste0(images.path, "late_timepoints/")
if (!dir.exists(pa)) dir.create(pa)

ft.time <- feature.table[day>=28 & status %in% c("DF", "SD") & cell_count>3000]
time.features <- d.all.stats[abs(effect)>0.5 & group1=="DF" & group2=="SD" & p.value<0.05, feature]
all.features <- setdiff(colnames(ft.lite), factors)

acute.conv.stats <- data.table(feature=character(), group1=character(),
                               group2=character(), p.value=numeric(), effect=numeric())
for (feature in all.features) {
  sd.acute.values <- ft.lite[status=="SD", eval(parse(text=feature))]
  df.acute.values <- ft.lite[status=="DF", eval(parse(text=feature))]
  sd.conv.values <- ft.time[status=="SD", eval(parse(text=feature))]
  df.conv.values <- ft.time[status=="DF", eval(parse(text=feature))]
  temp <- data.table(feature=rep(feature, 6),
                     group1=c("SD.acute", "SD.acute", "SD.acute", "DF.acute", "DF.acute", "SD.conv"),
                     group2=c("DF.acute", "SD.conv", "DF.conv", "SD.conv", "DF.conv", "DF.conv"),
                     p.value=c(wilcox.test(sd.acute.values, df.acute.values)$p.value,
                               wilcox.test(sd.acute.values, sd.conv.values)$p.value,
                               wilcox.test(sd.acute.values, df.conv.values)$p.value,
                               wilcox.test(df.acute.values, sd.conv.values)$p.value,
                               wilcox.test(df.acute.values, df.conv.values)$p.value,
                               wilcox.test(sd.conv.values, df.conv.values)$p.value),
                     effect=c(getEffectSize(sd.acute.values, df.acute.values),
                              getEffectSize(sd.acute.values, sd.conv.values),
                              getEffectSize(sd.acute.values, df.conv.values),
                              getEffectSize(df.acute.values, sd.conv.values),
                              getEffectSize(df.acute.values, df.conv.values),
                              getEffectSize(sd.conv.values, df.conv.values)))
  acute.conv.stats <- rbind(acute.conv.stats,temp)
}
setorder(acute.conv.stats, p.value)
acute.conv.stats[p.value<0.05 & abs(effect)>1, p.symbol:="#"]
acute.conv.stats[p.value<0.01 & abs(effect)>1, p.symbol:="##"]
acute.conv.stats[p.value<0.001 & abs(effect)>1, p.symbol:="###"]
acute.conv.stats[group1=="SD.conv" & p.value<0.05 & abs(effect)>1]
setorder(acute.conv.stats, p.value, effect)
fwrite(acute.conv.stats, paste0(path, "tables/convalescent_infection_stats.csv"))


ft.time.combined <- rbind(ft.lite[status %in% c("DF", "SD")], ft.time)
ft.time.combined[, subset:=paste0(status, ".conv")]
ft.time.combined[day<28, subset:=paste0(status, ".acute")]
ft.time.combined[, subset:=factor(subset, c("DF.acute", "SD.acute", "DF.conv", "SD.conv"))]

### Plasma cells

ggplot(ft.time.combined, aes(subset, B_Plasma)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="Plasma cells") +
  theme(legend.position="none") +
  ylim(0, 40) +
  stat_pvalue_manual(data=acute.conv.stats[feature=="B_Plasma"],
                     label="p.symbol",
                     y.position=25,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Plasma_box.eps"), height=2.5, width=2.5)

### Plasma ratio bargraph

temp <- ft.time.combined[, .(B_Plasma_log_IgG_IgA, subset, status)] %>%
  .[, `:=`(mean=mean(B_Plasma_log_IgG_IgA), se=sd(B_Plasma_log_IgG_IgA)/sqrt(.N)), by=.(subset, status)] %>%
  .[, .(subset, mean, se, status)] %>%
  unique()

ggplot(temp, aes(subset, mean)) +
  geom_col(aes(fill=status)) +
  labs(x=NULL, y="Log2 ratio (IgG/IgA)", title="Plasma cells") +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.3) +
  scale_fill_manual(values=status.colors) +
  stat_pvalue_manual(data=acute.conv.stats[feature=="B_Plasma_log_IgG_IgA"],
                     label="p.symbol",
                     y.position=2.65,
                     step.increase=0.1,
                     size=8) +
  scale_y_continuous(limits=c(-2.15, 3.15)) +
  theme_bw() +
  theme(legend.position="none")
ggsave(paste0(pa, "Plasma_ratio.eps"), width=2.5, height=2.5)


### Plasma Ki-67

ggplot(ft.time.combined, aes(subset, mean_Ki_67_B_Plasma)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="Mean Ki-67", title="Plasma cells") +
  theme(legend.position="none") +
  ylim(0, 0.75) +
  stat_pvalue_manual(data=acute.conv.stats[feature=="mean_Ki_67_B_Plasma"],
                     label="p.symbol",
                     y.position=0.57,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Plasma_ki67_box.eps"), height=2.5, width=2.5)


### Treg

ggplot(ft.time.combined, aes(subset, T_Treg)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="T_Treg") +
  theme(legend.position="none") +
  ylim(0, 2) +
  stat_pvalue_manual(data=acute.conv.stats[feature=="T_Treg"],
                     label="p.symbol",
                     y.position=2,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "treg.eps"), height=2.5, width=2.5)



### CD64 cDC2

ggplot(ft.time.combined, aes(subset, mean_CD64_M_cDC2)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="Mean CD64", title="cDC2") +
  theme(legend.position="none") +
  ylim(0.2, 1.05) +
  stat_pvalue_manual(data=acute.conv.stats[feature=="mean_CD64_M_cDC2"],
                     label="p.symbol",
                     y.position=0.87,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "cd64_cDC2.eps"), height=2.5, width=2.5)


### cDC2 abundance

ggplot(ft.time.combined, aes(subset, M_cDC_M_cDC2)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of cDC", title="cDC2") +
  theme(legend.position="none") +
  ylim(20, 120) +
  stat_pvalue_manual(data=acute.conv.stats[feature=="M_cDC_M_cDC2"],
                     label="p.symbol",
                     y.position=95,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "cDC2_abundance_late.eps"), height=2.5, width=2.5)



time.stats <- acute.conv.stats[group1=="SD.conv"] %>%
  .[, `:=`(group1="SD", group2="DF")]

### full population boxplots late timepoint only Ki-67

temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day>=28] %>%
  .[, mean(Ki_67), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- grep("Ki_67", all.features, value=T) %>%
  setdiff(c("mean_Ki_67_NK", "mean_Ki_67_M_Monocyte"))
p.values <- time.stats[feature %in% temp.features] %>%
  .[, population:=substring(feature, 12)] %>%
  .[, population:=factor(population, population.order)]


ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="Ki-67 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.5,
                     remove.bracket=T,
                     size=5) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "Ki_67_mean_population_boxplot.eps"), width=10, height=3)

### CD38
temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day>=28] %>%
  .[, mean(CD38), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- grep("CD38", all.features, value=T) %>%
  setdiff(c("mean_CD38_NK", "mean_CD38_M_Monocyte"))
p.values <- time.stats[feature %in% temp.features] %>%
  .[, population:=substring(feature, 11)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="CD38 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.65,
                     remove.bracket=T,
                     size=5) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "CD38_population_boxplot.eps"), width=10, height=3)

### CTLA-4

temp <- dat[type=="T" & status %in% c("DF", "SD") & cell_count>3000 & day>=28] %>%
  .[, mean(CTLA_4), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- grep("CTLA_4_T", all.features, value=T)
p.values <- time.stats[feature %in% temp.features] %>%
  .[, population:=substring(feature, 13)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="CTLA-4 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.65,
                     remove.bracket=T,
                     size=5) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "CTLA4_population_boxplot.eps"), width=6, height=3)


### HLA_DR boxplots
temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day>=28 &
              type %in% c("M", "NK") & population!="M_Basophil"] %>%
  .[, mean(HLA_DR), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- grep("HLA_DR_M", all.features, value=T) %>%
  c(grep("HLA_DR_N", all.features, value=T)) %>%
  setdiff(c("mean_HLA_DR_NK", "mean_HLA_DR_M_Monocyte", "mean_HLA_DR_M_Basophil"))
p.values <- time.stats[feature %in% temp.features] %>%
  .[, population:=substring(feature, 13)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="HLA_DR") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.65,
                     remove.bracket=T,
                     size=5) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "HLA_DR_population_boxplot.eps"), width=5, height=3)

### PD-L1 

temp <- dat[status %in% c("DF", "SD") & cell_count>3000 & day>=28] %>%
  .[, mean(PD_L1), by=.(patient, status, population)]
population.order <- temp[status=="SD", median(V1), by=population] %>%
  .[order(V1), population]
temp[, population:=factor(population, population.order)]

temp.features <- grep("PD_L1", all.features, value=T) %>%
  setdiff(c("mean_PD_L1_NK", "mean_PD_L1_M_Monocyte"))
p.values <- time.stats[feature %in% temp.features] %>%
  .[, population:=substring(feature, 12)] %>%
  .[, population:=factor(population, population.order)]

ggplot(temp, aes(population, V1, color=status)) +
  geom_boxplot(outlier.shape=NA) +
  labs(x=NULL, y="Mean expression", title="PD-L1 expression") +
  scale_color_manual(values=status.colors) +
  theme_bw() +
  ylim(0, 0.23) +
  stat_pvalue_manual(data=p.values,
                     label="p.symbol",
                     x="population",
                     y.position=0.15,
                     remove.bracket=T,
                     size=5) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "PDL1_population_boxplot.eps"), width=10, height=3)

### Innate differences heatmap

markers <- c("HLA_DR", "CD64", "CD38", "Ki_67", "PD_L1", "CD209", "CD141")
pops <- c("M_cDC1", "M_cDC2", "M_pDC", "M_Mono_CD14", "M_Mono_CD16", "M_Mono_DP", "M_Mono_DN")
features <- expand.grid(markers, pops) %>%
  apply(1, paste, collapse="_") %>%
  paste0("mean_", .)

myeloid.compare.dt <- ft.time[, c("status", features), with=F] %>%
  .[, lapply(.SD, median), by=status] %>%
  melt(id.vars="status", variable.name="feature") %>%
  dcast(feature~status) %>%
  .[, dif:=SD-DF] %>%
  cbind(as.data.table(expand.grid(markers, pops))) %>%
  .[, `:=`(SD=NULL, DF=NULL, feature=NULL)]
setnames(myeloid.compare.dt, c("Var1", "Var2"), c("marker", "population"))

differences <- myeloid.compare.dt %>%
  dcast(population~marker, value.var="dif") %>%
  as.matrix(rownames="population") %>%
  t()

breaks <- seq(-.15, .15, length.out=22)

setEPS()
postscript(paste0(pa, "heatmap_D_SD_differences_late.eps"), width=3.5, height=3)
pheatmap(mat=differences, color=div.palette, breaks=breaks, angle_col=45)
dev.off()

### cDC2 IgG CD64
n.sample <- dat[population=="M_cDC2" & day>=28 & status=="DF", .N] * 4
subsampled <- subsampleStatusSmall(dat[status %in% c("DF", "SD") & cell_count>3000 &
                                         (day>=28 | day<0) & population=="M_cDC2"],
                                   n.cells=n.sample)
cd64.co <- cutoffs[marker=="CD64", cutoff]
subsampled[, `:=`(CD64.pos=CD64>cd64.co, IgG.pos=IgG>0.15)]

cor.table <- data.table(status=c("DF", "SD"), cor=numeric(), p.value=numeric())
for (st in c("DF", "SD")) {
  cor.out <- cor.test(subsampled[status==st, CD64], subsampled[status==st, IgG])
  cor.table[status==st, `:=`(cor=cor.out$estimate, p.value=cor.out$p.value)]
}

extra <- subsampled[, .N, by=.(status, IgG.pos, CD64.pos)] %>%
  .[, P:=100*N/sum(N), by=status]

subsampled[, density:=getDensity(IgG, CD64, n=100), by=status]
ggplot(subsampled, aes(IgG, CD64)) +
  geom_point(size=0.2, aes(color=density)) +
  geom_hline(yintercept=cd64.co, linetype="dashed") +
  geom_vline(xintercept=0.15, linetype="dashed") +
  xlim(0, 0.85) +
  geom_label(data=extra[IgG.pos==T & CD64.pos==T], aes(x=0.75, y=1.1, label=paste0(round(P, 2), "%"))) +
  geom_label(data=extra[IgG.pos==F & CD64.pos==T], aes(x=0.1, y=1.1, label=paste0(round(P, 2), "%"))) +
  theme_bw() +
  facet_wrap(~status, nrow=2) +
  scale_color_viridis() +
  theme(legend.position="none")
ggsave(paste0(pa, "cDC2_CD64_IgG.png"), width=2.7, height=5)

### Monocytes IgG CD64

subsampled <- subsampleStatusSmall(dat[status %in% c("DF", "SD") & cell_count>3000 &
                                       (day>=28 | day<0) & subtype=="M_Monocyte"],
                                   n.cells=n.sample)
cd64.co <- cutoffs[marker=="CD64", cutoff]
subsampled[, `:=`(CD64.pos=CD64>cd64.co, IgG.pos=IgG>0.15)]

cor.table <- data.table(status=c("DF", "SD"), cor=numeric(), p.value=numeric())
for (st in c("DF", "SD")) {
  cor.out <- cor.test(subsampled[status==st, CD64], subsampled[status==st, IgG])
  cor.table[status==st, `:=`(cor=cor.out$estimate, p.value=cor.out$p.value)]
}

extra <- subsampled[, .N, by=.(status, IgG.pos, CD64.pos)] %>%
  .[, P:=100*N/sum(N), by=status]

subsampled[, density:=getDensity(IgG, CD64, n=100), by=status]
ggplot(subsampled, aes(IgG, CD64)) +
  geom_point(size=0.2, aes(color=density)) +
  geom_hline(yintercept=cd64.co, linetype="dashed") +
  geom_vline(xintercept=0.15, linetype="dashed") +
  geom_label(data=extra[IgG.pos==T & CD64.pos==T], aes(x=0.75, y=1.1, label=paste0(round(P, 2), "%"))) +
  geom_label(data=extra[IgG.pos==F & CD64.pos==T], aes(x=0.1, y=1.1, label=paste0(round(P, 2), "%"))) +
  theme_bw() +
  xlim(0, 0.9) +
  facet_wrap(~status) +
  scale_color_viridis() +
  theme(legend.position="none")
ggsave(paste0(pa, "Monocytes_CD64_IgG.png"), width=5, height=3)


### Mono bar trends
mono.features <- paste0("M_Monocyte_M_Mono_", c("DN", "DP", "CD14", "CD16"))

temp <- ft.time[status %in% c("DF", "SD"), c(mono.features, "status"), with=F] %>%
  melt(id.vars="status", variable.name="population", value.name="P") %>%
  .[, `:=`(median=median(P)), by=.(status, population)] %>%
  .[, .(status, population, median)] %>%
  unique() %>%
  dcast(population~status, value.var="median") %>%
  .[, ratio:=SD-DF] %>%
  .[, sig:=F] %>%
  .[, population:=substring(population, 14)] %>%
  .[, population:=factor(population, population[c(1,3,4,2)])]

ggplot(temp, aes(population, ratio, fill=sig)) +
  geom_col() +
  labs(x=NULL, y="Median SD - median DF", title="% of Monocytes") +
  scale_fill_manual(values=c("grey70", "#187A7A")) +
  theme_bw() +
  ylim(-6, 5) +
  theme(legend.position="none",
        axis.text.x=element_text(hjust=1, angle=45))
ggsave(paste0(pa, "Mono_bar_trends_late.eps"), width=2.5, height=2.7)



##### Figure 6 timecourse + supplement #####

pa <- paste0(images.path, "figure_4/")
if (!dir.exists(pa)) dir.create(pa)

ft.course <- feature.table[day>=2 & day<=9 & status %in% c("DF", "SD") & cell_count>3000] %>%
  .[order(day)]

features <- setdiff(colnames(ft.course), factors)
day.ranges <- c(3, 8)
ft.course.rolling <- copy(ft.course) %>%
  .[, rolling.day:=day] %>%
  rbind(copy(.)[, rolling.day:=day+1], copy(.)[, rolling.day:=day-1]) %>%
  .[rolling.day>2 & rolling.day<9]


### Stats

pseudo.stats <- data.table(feature=character(), rolling.day=numeric(), p.value=numeric(), effect=numeric())
for (feature in features) {
  for(i in unique(ft.course.rolling$rolling.day)) {
    sd.values <- ft.course.rolling[status=="SD" & rolling.day==i, eval(parse(text=feature))]
    df.values <- ft.course.rolling[status=="DF" & rolling.day==i, eval(parse(text=feature))]
    temp.p <- wilcox.test(sd.values, df.values)$p.value
    temp.effect <- getEffectSize(sd.values, df.values)
    pseudo.stats <- rbind(pseudo.stats, data.table(feature=feature,
                                                   rolling.day=i,
                                                   p.value=temp.p,
                                                   effect=temp.effect))
  }
}


pseudo.stats[p.value<0.05 & abs(effect)>1, p.symbol:="#"]
pseudo.stats[p.value<0.01 & abs(effect)>1, p.symbol:="##"]
pseudo.stats[p.value<0.001 & abs(effect)>1, p.symbol:="###"]
pseudo.stats[, `:=`(group1="DF", group2="SD")]
setorder(pseudo.stats, p.value, effect)
fwrite(pseudo.stats, paste0(path, "tables/timecourse_stats.csv"))

ps.lite <- pseudo.stats[p.value<0.05 & abs(effect)>1]

### CD38 heatmap

cd38.features <- grep("CD38_T", colnames(ft.course.rolling), value=T) %>%
  c(grep("CD38_M", colnames(ft.course.rolling), value=T)) %>%
  setdiff(c("mean_CD38_M_Monocyte", "mean_CD38_M_Basophil"))


temp <- ft.course.rolling[, c("status", "rolling.day", cd38.features), with=F] %>%
  melt(id.vars=c("status", "rolling.day"), variable.name="population", value.name="expression") %>%
  .[, population:=substring(population, 11)] %>%
  .[, mean(expression), by=.(status, rolling.day, population)] %>%
  dcast(rolling.day+population~status) %>%
  .[, dif:=SD-DF] %>%
  .[, `:=`(DF=NULL, SD=NULL)] %>%
  dcast(rolling.day~population, value.var="dif") %>%
  as.matrix(rownames="rolling.day") %>%
  t()

my.breaks <- range(10*temp) %>%
  abs() %>%
  max() %>%
  ceiling() %>%
  seq(-., ., length.out=22)/10

setEPS()
postscript(paste0(pa, "cd38_heatmap.eps"), width=4, height=5)
pheatmap(temp,
         col=div.palette,
         cluster_cols=F,
         breaks=my.breaks,
         angle_col=0)
dev.off()

### CD8 T EM CD38
temp <- ft.course.rolling[, .(mean_CD38_T_CD8_EM, status, rolling.day)] %>%
  setnames("mean_CD38_T_CD8_EM", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(0.2, 0.5) +
  stat_pvalue_manual(data=ps.lite[feature=="mean_CD38_T_CD8_EM"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=0.48,
                     remove.bracket=T,
                     size=8) +
  labs(y="Mean CD38", x="Day", title="CD8+ T EM") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "TEM_CD38_abundance.eps"), width=2.5, height=2.5)

### CD14 Mono CD38
temp <- ft.course.rolling[, .(mean_CD38_M_Mono_CD14, status, rolling.day)] %>%
  setnames("mean_CD38_M_Mono_CD14", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(0.33, 0.48) +
  stat_pvalue_manual(data=ps.lite[feature=="mean_CD38_M_Mono_CD14"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=0.47,
                     remove.bracket=T,
                     size=8) +
  labs(y="Mean CD38", x="Day", title="CD14+ Mono") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "Mono_CD14_CD38_abundance.eps"), width=2.5, height=2.5)


### Plasma cell abundance
temp <- ft.course.rolling[, .(B_Plasma, status, rolling.day)] %>%
  setnames("B_Plasma", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(0, 15) +
  stat_pvalue_manual(data=ps.lite[feature=="B_Plasma"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=14.5,
                     remove.bracket=T,
                     size=8) +
  labs(y="% of CD45+", x="Day", title="Plasma cells") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "plasma_abundance.eps"), width=2.5, height=2.5)

### Plasma cell Ki-67

temp <- ft.course.rolling[, .(mean_Ki_67_B_Plasma, status, rolling.day)] %>%
  setnames("mean_Ki_67_B_Plasma", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(0.26, 0.41) +
  stat_pvalue_manual(data=ps.lite[feature=="mean_Ki_67_B_Plasma"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=0.405,
                     remove.bracket=T,
                     size=8) +
  labs(y="Mean Ki-67", x="Day", title="Plasma cells") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "plasma_ki67.eps"), width=2.5, height=2.5)

### Plasma cell IgG:IgA

temp <- ft.course.rolling[, .(B_Plasma_log_IgG_IgA, status, rolling.day)] %>%
  setnames("B_Plasma_log_IgG_IgA", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(-1.3, 3.5) +
  stat_pvalue_manual(data=ps.lite[feature=="B_Plasma_log_IgG_IgA"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=3.4,
                     remove.bracket=T,
                     size=8) +
  labs(y="Log2(IgG+/IgA+)", x="Day", title="Plasma cells") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "plasma_igg_iga.eps"), width=2.5, height=2.5)

### NK CD69

temp <- ft.course.rolling[, .(mean_CD69_NK, status, rolling.day)] %>%
  setnames("mean_CD69_NK", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  stat_pvalue_manual(data=ps.lite[feature=="mean_CD69_NK"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=0.27,
                     remove.bracket=T,
                     size=8) +
  labs(y="Mean CD69", x="Day", title="NK cells") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "nk_cd69.eps"), width=2.5, height=2.5)

### NK PD-L1

temp <- ft.course.rolling[, .(mean_PD_L1_NK, status, rolling.day)] %>%
  setnames("mean_PD_L1_NK", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(0.06, 0.155) +
  stat_pvalue_manual(data=ps.lite[feature=="mean_PD_L1_NK"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=0.15,
                     remove.bracket=T,
                     size=8) +
  labs(y="Mean PD-L1", x="Day", title="NK cells") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "nk_pdl1.eps"), width=2.5, height=2.5)

### PD-L1 heatmaps

pdl1.features <- grep("PD_L1", colnames(ft.course.rolling), value=T) %>%
  setdiff(c("mean_PD_L1_M_Monocyte", "mean_PD_L1_NK"))

temp <- ft.course.rolling[, c("status", "rolling.day", pdl1.features), with=F] %>%
  melt(id.vars=c("status", "rolling.day"), variable.name="population", value.name="expression") %>%
  .[, population:=substring(population, 12)] %>%
  .[, mean(expression), by=.(status, rolling.day, population)] %>%
  .[, V1:=(V1-min(V1))/(max(V1)-min(V1)), by=population]

### Individual heatmaps
ggplot(temp, aes(rolling.day, status, fill=V1)) +
  geom_tile() +
  scale_fill_viridis(option="B") +
  facet_wrap(~population, scales="free") +
  theme_bw() +
  labs(x=NULL, y=NULL, title=NULL) +
  theme(axis.text=element_blank(),
        axis.ticks=element_blank(),
        panel.grid=element_blank(),
        strip.background=element_blank(),
        panel.border=element_blank())
ggsave(paste0(pa, "pd_l1_tile.eps"), width=8, height=4)

### Individual line plots

temp <- ft.course.rolling[, c("status", "rolling.day", pdl1.features), with=F] %>%
  melt(id.vars=c("status", "rolling.day"), variable.name="population", value.name="expression") %>%
  .[, population:=substring(population, 12)] %>%
  .[, `:=`(mean=mean(expression), se=sd(expression)/sqrt(.N)), by=.(status, rolling.day, population)] %>%
  .[, expression:=NULL] %>%
  unique()


ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  facet_wrap(~population, scales="free") +
  labs(y="Mean PD-L1", x="Day") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "pdl1_lines.eps"), height=9, width=12)


### Treg abundance
temp <- ft.course.rolling[, .(T_Treg, status, rolling.day)] %>%
  setnames("T_Treg", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(0.2, 1.1) +
  stat_pvalue_manual(data=ps.lite[feature=="T_Treg"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=1.05,
                     remove.bracket=T,
                     size=8) +
  labs(y="% of CD45+", x="Day", title="Tregs") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "treg_abundance.eps"), width=2.5, height=2.5)


### Treg PD-1
temp <- ft.course.rolling[, .(mean_PD_1_T_Treg, status, rolling.day)] %>%
  setnames("mean_PD_1_T_Treg", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(0.09, 0.34) +
  stat_pvalue_manual(data=ps.lite[feature=="mean_PD_1_T_Treg"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=0.33,
                     remove.bracket=T,
                     size=8) +
  labs(y="Mean PD-1", x="Day", title="Tregs") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "treg_pd1.eps"), width=2.5, height=2.5)

### Treg CTLA-4
temp <- ft.course.rolling[, .(mean_CTLA_4_T_Treg, status, rolling.day)] %>%
  setnames("mean_CTLA_4_T_Treg", "value") %>%
  .[, `:=`(mean=mean(value), se=sd(value)/sqrt(.N)), by=.(status, rolling.day)] %>%
  .[, value:=NULL] %>%
  unique()

ggplot(temp, aes(rolling.day, mean, color=status)) +
  geom_point(size=2) +
  geom_line() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.2) +
  theme_bw() +
  scale_color_manual(values=status.colors) +
  ylim(0.35, 0.76) +
  stat_pvalue_manual(data=ps.lite[feature=="mean_CTLA_4_T_Treg"],
                     label="p.symbol",
                     x="rolling.day",
                     y.position=0.75,
                     remove.bracket=T,
                     size=8) +
  labs(y="Mean CTLA-4", x="Day", title="Tregs") +
  theme(legend.position="none", panel.grid.minor=element_blank())
ggsave(paste0(pa, "treg_ctla4.eps"), width=2.5, height=2.5)


### CTLA-4
all.features <- setdiff(colnames(ft.course), factors)
features <- grep("CTLA_4_T", all.features, value=T)

temp <- ft.course.rolling[, .SD, .SDcols=c(features, "status", "rolling.day")] %>%
  melt(id.vars=c("status", "rolling.day")) %>%
  .[, value:=mean(value), by=.(status, rolling.day, variable)] %>%
  unique() %>%
  dcast(rolling.day+variable~status) %>%
  .[, diff:=SD-DF] %>%
  .[, `:=`(DF=NULL, SD=NULL)] %>%
  dcast(variable~rolling.day) %>%
  as.matrix(rownames="variable")
rownames(temp) <- substring(rownames(temp), 13)

my.breaks <- range(10*temp) %>%
  abs() %>%
  max() %>%
  ceiling() %>%
  seq(-., ., length.out=22)/10

setEPS()
postscript(paste0(pa, "heatmap_CTLA_4.eps"), width=4, height=3.5)
pheatmap(mat=temp, color=div.palette, breaks=my.breaks, cluster_cols=F, angle_col=0)
dev.off()

### CD64
all.features <- setdiff(colnames(ft.course), factors)
features <- grep("CD64", all.features, value=T) %>%
  setdiff(c("mean_CD64_M_Monocyte", "mean_CD64_M_Basophil"))
temp <- ft.course.rolling[, .SD, .SDcols=c(features, "status", "rolling.day")] %>%
  melt(id.vars=c("status", "rolling.day")) %>%
  .[, value:=mean(value), by=.(status, rolling.day, variable)] %>%
  unique() %>%
  dcast(rolling.day+variable~status) %>%
  .[, diff:=SD-DF] %>%
  .[, `:=`(DF=NULL, SD=NULL)] %>%
  dcast(variable~rolling.day) %>%
  as.matrix(rownames="variable")
rownames(temp) <- substring(rownames(temp), 13)

my.breaks <- range(10*temp) %>%
  abs() %>%
  max() %>%
  ceiling() %>%
  seq(-., ., length.out=22)/10

setEPS()
postscript(paste0(pa, "heatmap_CD64.eps"), width=4, height=2.3)
pheatmap(mat=temp, color=div.palette, breaks=my.breaks, cluster_cols=F, angle_col=0)
dev.off()


### HLA-DR
all.features <- setdiff(colnames(ft.course.rolling), factors)
features <- grep("HLA_DR_M", all.features, value=T) %>%
  setdiff(c("mean_HLA_DR_M_Monocyte", "mean_HLA_DR_M_Basophil"))
temp <- ft.course.rolling[, .SD, .SDcols=c(features, "status", "rolling.day")] %>%
  melt(id.vars=c("status", "rolling.day")) %>%
  .[, value:=mean(value), by=.(status, rolling.day, variable)] %>%
  unique() %>%
  dcast(rolling.day+variable~status) %>%
  .[, diff:=SD-DF] %>%
  .[, `:=`(DF=NULL, SD=NULL)] %>%
  dcast(variable~rolling.day) %>%
  as.matrix(rownames="variable")
rownames(temp) <- substring(rownames(temp), 15)

my.breaks <- range(10*temp) %>%
  abs() %>%
  max() %>%
  ceiling() %>%
  seq(-., ., length.out=22)/10

setEPS()
postscript(paste0(pa, "heatmap_HLA_DR.eps"), width=4, height=2.3)
pheatmap(mat=temp, color=div.palette, breaks=my.breaks, cluster_cols=F, angle_col=0)
dev.off()

### Stacked bar Monocytes
features <- grep("M_Monocyte_M", pseudo.stats$feature, value=T) %>%
  unique()
temp <- ft.course.rolling[, c(features, "status", "rolling.day"), with=F] %>%
  .[, lapply(.SD, mean), .SDcols=features, by=.(status, rolling.day)] %>%
  melt(id.vars=c("status", "rolling.day"), variable.name="population", value.name="P") %>%
  .[, population:=substring(population, 19)] %>% 
  .[, population:=factor(population, c("DN", "CD14", "CD16", "DP"))] %>%
  .[order(population)]

mono.pal <- four.color.pal
ggplot(temp, aes(rolling.day, P, fill=population, group=status)) +
  geom_col() +
  theme_bw() +
  facet_wrap(~status, nrow=2) +
  labs(x="Day", y="% of Monocytes", title="Monocytes") +
  scale_fill_manual(values=mono.pal) +
  scale_x_continuous(breaks=3:8) +
  theme(panel.grid=element_blank())
ggsave(paste0(pa, "monocyte_abundance.eps"), width=4.3, height=6)


### Supplements of patient composition

temp <- ft.course.rolling[, .(rolling.day, status)] %>%
  setnames("rolling.day", "day") %>%
  .[, day:=factor(day)]

ggplot(temp, aes(day, fill=status)) +
  geom_bar() +
  theme_bw() +
  scale_fill_manual(values=status.colors) +
  labs(y="Patients", x="Day")
ggsave(paste0(pa, "status_count.eps"), height=2.5, width=3.3)

temp <- ft.course.rolling[, .(rolling.day, adult)] %>%
  setnames("rolling.day", "day") %>%
  .[, day:=factor(day)]

ggplot(temp, aes(day, fill=adult)) +
  geom_bar() +
  theme_bw() +
  labs(y="Patients", x="Day")
ggsave(paste0(pa, "adult_count.eps"), height=2.5, width=3.3)



##### Figure 4 Child Adult + supplement #####

pa <- paste0(images.path, "figure_5/")
if (!dir.exists(pa)) dir.create(pa)

features <- setdiff(colnames(ft.lite), factors)

ft.age <- ft.lite[status %in% c("DF", "SD")]
ft.age[adult==F & status=="DF", group:="DF.child"]
ft.age[adult==F & status=="SD", group:="SD.child"]
ft.age[adult==T & status=="DF", group:="DF.adult"]
ft.age[adult==T & status=="SD", group:="SD.adult"]
ft.age[, group:=factor(group, c("DF.adult", "SD.adult", "DF.child", "SD.child"))]

age.stats <- data.table(feature=character(), group1=character(), group2=character(), p.value=numeric(), effect=numeric())
for (feature in features) {
  sd.adult.values <- ft.age[group=="SD.adult", eval(parse(text=feature))]
  df.adult.values <- ft.age[group=="DF.adult", eval(parse(text=feature))]
  sd.child.values <- ft.age[group=="SD.child", eval(parse(text=feature))]
  df.child.values <- ft.age[group=="DF.child", eval(parse(text=feature))]
  temp <- data.table(feature=rep(feature, 4),
                     group1=c("SD.adult", "SD.adult", "DF.adult", "SD.child"),
                     group2=c("DF.adult", "SD.child", "DF.child", "DF.child"),
                     p.value=c(wilcox.test(sd.adult.values, df.adult.values)$p.value,
                               wilcox.test(sd.adult.values, sd.child.values)$p.value,
                               wilcox.test(df.adult.values, df.child.values)$p.value,
                               wilcox.test(sd.child.values, df.child.values)$p.value),
                     effect=c(getEffectSize(sd.adult.values, df.adult.values),
                              getEffectSize(sd.adult.values, sd.child.values),
                              getEffectSize(df.adult.values, df.child.values),
                              getEffectSize(sd.child.values, df.child.values)))
  age.stats <- rbind(age.stats,temp)
}

age.stats[p.value<0.05 & abs(effect)>1, p.symbol:="#"]
age.stats[p.value<0.01 & abs(effect)>1, p.symbol:="##"]
age.stats[p.value<0.001 & abs(effect)>1, p.symbol:="###"]
setorder(age.stats, p.value, effect)
fwrite(age.stats, paste0(path, "tables/age_stats.csv"))

### Abundance differences

temp <- ft.age[, colnames(percents), with=F] %>%
  .[, lapply(.SD, median), .SDcols=setdiff(colnames(percents), factors), by=.(status, adult)] %>%
  melt(id.vars=c("status", "adult"), value.name="median", variable.name="population") %>%
  dcast(adult+population~status, value.var="median") %>%
  .[, ratio:=log2(SD/DF)] %>%
  .[order(ratio)] %>%
  .[, `:=`(DF=NULL, SD=NULL)] %>%
  dcast(population~adult, value.var="ratio") %>%
  setnames(c("population", "child", "adult"))

sig.adult <- age.stats[p.value<0.05 & abs(effect)>1 & feature %in% colnames(percents) &
                         group2=="DF.adult", as.character(feature)]
sig.child <- age.stats[p.value<0.05 & abs(effect)>1 & feature %in% colnames(percents) &
                         group1=="SD.child", as.character(feature)]
temp[, significant:="No"]
temp[population %in% sig.adult, significant:="Adult"]
temp[population %in% sig.child, significant:="Child"]
temp[, significant:=factor(significant, c("No", "Adult", "Child"))]

temp.effect <- age.stats[feature %in% colnames(percents) & group2=="DF.adult", .(feature, effect)] %>%
  setnames(c("population", "adult")) %>%
  merge(temp[, .(population, significant)], by="population")
temp.effect <- age.stats[feature %in% colnames(percents) & group1=="SD.child", .(feature, effect)] %>%
  setnames(c("population", "child")) %>%
  merge(temp.effect, by="population")

adult.limits <- range(10*temp.effect$adult) %>%
  abs() %>%
  max() %>%
  ceiling() %>%
  c(-., .)/10
child.limits <- range(10*temp.effect$child) %>%
  abs() %>%
  max() %>%
  ceiling() %>%
  c(-., .)/10

labeled.features <- c("B_Plasma", "T_Treg", "M_Mono_CD16", "NK_DP")

ggplot(temp.effect, aes(adult, child, color=significant)) +
  geom_point() +
  geom_label_repel(data=temp.effect[population %in% labeled.features], aes(label=population), max.overlaps=15) +
  xlim(adult.limits) +
  ylim(child.limits) +
  scale_color_manual(values=c("grey50", "#187A7A", "#E09B2D")) +
  theme_bw() +
  labs(x="Adult effect size", y="Child effect size") +
  theme(legend.position="none")
ggsave(paste0(pa, "abundance_effects.eps"), width=3, height=3)


### Plasma B main
ggplot(ft.age, aes(group, B_Plasma)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="Plasma cells") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=age.stats[feature=="B_Plasma" & p.value<0.05 & abs(effect)>1],
                     label="p.symbol",
                     y.position=25,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Plasma_box.eps"), height=2.5, width=2.5)

### Plasma Ki-67 main

ggplot(ft.age, aes(group, mean_Ki_67_B_Plasma)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="Mean Ki-67", title="Plasma cells") +
  theme(legend.position="none") +
  ylim(c(0, 0.53)) +
  stat_pvalue_manual(data=age.stats[feature=="mean_Ki_67_B_Plasma" & p.value<0.05 & abs(effect)>1],
                     label="p.symbol",
                     y.position=0.5,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Plasma_ki_67_box.eps"), height=2.5, width=2.5)


### Plasma PD-L1 supplement

ggplot(ft.age, aes(group, mean_PD_L1_B_Plasma)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="Mean PD-L1", title="Plasma cells") +
  theme(legend.position="none") +
  ylim(c(0.07, 0.3)) +
  stat_pvalue_manual(data=age.stats[feature=="mean_PD_L1_B_Plasma" & p.value<0.05 & abs(effect)>1],
                     label="p.symbol",
                     y.position=0.27,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Plasma_pd_l1_box.eps"), height=2.5, width=2.5)

### Treg supplement
ggplot(ft.age, aes(group, T_Treg)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="Tregs") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=age.stats[feature=="T_Treg"],
                     label="p.symbol",
                     y.position=1,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Treg_box.eps"), height=2.5, width=2.5)

### CD16+ Monocyte supplement
ggplot(ft.age, aes(group, M_Mono_CD16)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="CD16+ Monocytes") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=age.stats[feature=="M_Mono_CD16"],
                     label="p.symbol",
                     y.position=1,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Mono_CD16_box.eps"), height=2.5, width=2.5)


### CD8 TEMRA supplement
ggplot(ft.age, aes(group, T_CD8_EMRA)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="CD8+ TEMRA") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=age.stats[feature=="T_CD8_EMRA"],
                     label="p.symbol",
                     y.position=1,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "CD8_TEMRA_box.eps"), height=2.5, width=2.5)

### CD8 TEMRA HLA-DR Supplement
ggplot(ft.age, aes(group, mean_HLA_DR_T_CD8_EMRA)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="mean HLA-DR", title="CD8+ TEMRA") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=age.stats[feature=="mean_HLA_DR_T_CD8_EMRA"],
                     label="p.symbol",
                     y.position=0.2,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "CD8_TEMRA_HLA_box.eps"), height=2.5, width=2.5)

### CD8 TEMRA CD38 Supplement
ggplot(ft.age, aes(group, mean_CD38_T_CD8_EMRA)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="mean CD38", title="CD8+ TEMRA") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=age.stats[feature=="mean_CD38_T_CD8_EMRA"],
                     label="p.symbol",
                     y.position=0.42,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "CD8_TEMRA_CD38_box.eps"), height=2.5, width=2.5)

### DP NK main
ggplot(ft.age, aes(group, NK_DP)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="DP NK cells") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=age.stats[feature=="NK_DP" & p.value<0.05 & abs(effect)>1],
                     label="p.symbol",
                     y.position=18,
                     step.increase=0.15,
                     size=10)
ggsave(paste0(pa, "NK_DP_box.eps"), height=2.5, width=2.5)

### Mean CD16 DP NK 
ggplot(ft.age, aes(group, mean_CD16_NK_DP)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="Mean CD16", title="DP NK cells") +
  theme(legend.position="none") +
  stat_pvalue_manual(data=age.stats[feature=="mean_CD16_NK_DP" & p.value<0.05 & abs(effect)>1],
                     label="p.symbol",
                     y.position=0.72,
                     step.increase=0.15,
                     size=10)
ggsave(paste0(pa, "NK_DP_CD16_box.eps"), height=2.5, width=2.5)

### NK Children stacked bar

temp <- ft.age[adult==F, .(patient, status, NK_NK_DN, NK_NK_CD16, NK_NK_CD56, NK_NK_DP)] %>%
  melt(id.vars=c("patient", "status"), variable.name="population", value="percent")

patient.order <- temp[population=="NK_NK_DP"] %>%
  .[order(percent), patient]
temp[, patient:=factor(patient, patient.order)]
labels <- temp[order(patient), .(status, patient)] %>%
  unique() %>%
  .[, status]
temp[, population:=substring(population, 7)]
temp[, population:=factor(population, c("DP", "CD56", "CD16", "DN"))]

ggplot(temp, aes(patient, percent, fill=population)) +
  geom_col() +
  theme_bw() + 
  scale_fill_manual(values=rev(four.color.pal)) +
  theme(axis.text.x=element_text(hjust=1, angle=45),
        panel.grid.minor=element_blank(),
        panel.grid.major.x=element_blank(),
        legend.position="none") +
  scale_x_discrete(labels=labels) +
  labs(x="Patient Status", y="% NK cells", title="Child")
ggsave(paste0(pa, "NK_population_child.eps"), width=5, height=2.6)


### NK Adult stacked bar

temp <- ft.age[adult==T, .(patient, status, NK_NK_DN, NK_NK_CD16, NK_NK_CD56, NK_NK_DP)] %>%
  melt(id.vars=c("patient", "status"), variable.name="population", value="percent")

patient.order <- temp[population=="NK_NK_DP"] %>%
  .[order(percent), patient]
temp[, patient:=factor(patient, patient.order)]
labels <- temp[order(patient), .(status, patient)] %>%
  unique() %>%
  .[, status]
temp[, population:=substring(population, 7)]
temp[, population:=factor(population, c("DP", "CD56", "CD16", "DN"))]

ggplot(temp, aes(patient, percent, fill=population)) +
  geom_col() +
  theme_bw() + 
  scale_fill_manual(values=rev(four.color.pal)) +
  theme(axis.text.x=element_text(hjust=1, angle=45),
        panel.grid.minor=element_blank(),
        panel.grid.major.x=element_blank(),
        legend.position="none") +
  scale_x_discrete(labels=labels) +
  labs(x="Patient Status", y="% NK cells", title="Adult")
ggsave(paste0(pa, "NK_population_adult.eps"), width=8, height=2.6)

adult.features <- age.stats[p.value<0.05 & abs(effect)>1 & group2=="DF.adult", feature]
child.features <- age.stats[p.value<0.05 & abs(effect)>1 & group1=="SD.child", feature]
sig.features <- unique(c(adult.features, child.features))

### HLA_DR Heatmap

features <- paste0("mean_HLA_DR_", c("NK_DN", "NK_CD56", "NK_CD16", "NK_DP",
                                     "M_Mono_DN", "M_Mono_CD14", "M_Mono_CD16", "M_Mono_DP",
                                     "M_cDC1", "M_cDC2", "M_pDC"))
temp <- ft.age[, c("group", features), with=F] %>%
  .[, lapply(.SD, mean), by=group] %>%
  setnames(features, substring(features, 13)) %>%
  transpose(make.names="group", keep.names="population") %>%
  .[, `:=`(adult=SD.adult-DF.adult, child=SD.child-DF.child)] %>%
  .[, .(population, adult, child)] %>%
  as.matrix(rownames="population") %>%
  t()

my.breaks <- range(10*temp) %>%
  abs() %>%
  max() %>%
  ceiling() %>%
  seq(-., ., length.out=22)/10

setEPS()
postscript(paste0(pa, "hla_dr_heatmap.eps"), width=5, height=1.8)
pheatmap(temp,
         color=div.palette,
         cluster_cols=F,
         breaks=my.breaks,
         main="Mean HLA-DR Difference",
         angle_col=45)
dev.off()


##### Figure 5 SD subtypes + supplement #####

pa <- paste0(images.path, "figure_6/")
if (!dir.exists(pa)) dir.create(pa)

sd.factors <- c(factors, "sd_type")

sd.meta.table <- fread(sd.meta.path)

ft.sd <- feature.table[day<12 & status=="SD" & cell_count>3000 & sample_number %in% c(0,1)] %>%
  merge(sd.meta.table, all.x=T, by="patient") %>%
  .[!is.na(sd_type)]

features <- setdiff(colnames(ft.sd), sd.factors)
ft.sd.df <- ft.lite %>%
  merge(sd.meta.table, all.x=T, by="patient")
ft.sd.df[status=="SD", status:=sd_type]
ft.sd.df <- ft.sd.df[status %in% c("C", "DF", "DWS", "DHF", "OI")]
status.colors.sd <- status.colors %>%
  setNames(c(names(status.colors[1:3]), "DHF", "OI"))

sd.stats <- calculateSDSubtypeStats(dt=ft.sd.df, columns=features)
melted.stats <- getSDStats(sd.stats)
melted.stats <- melted.stats[order(-abs(effect))]
melted.stats[p.value<0.05 & abs(effect)>1]
melted.features <- melted.stats[abs(effect)>1 & p.value<0.05 & group1=="DHF", feature] %>%
  unique()
melted.stats[abs(effect)>1 & p.value<0.05, p.symbol:="#"]
melted.stats[abs(effect)>1 & p.value<0.01, p.symbol:="##"]
melted.stats[abs(effect)>1 & p.value<0.001, p.symbol:="###"]

setorder(melted.stats, p.value, effect)
fwrite(melted.stats, paste0(path, "tables/SD_subtype_stats.csv"))


### cDC1
ggplot(ft.sd.df, aes(status, M_cDC1)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors.sd) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="cDC1") +
  theme(legend.position="none") +
  ylim(0, 0.45) +
  stat_pvalue_manual(data=melted.stats[feature=="M_cDC1"],
                     label="p.symbol",
                     y.position=0.25,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "cDC1_box.eps"), height=2.5, width=2.5)

# cDC2
ggplot(ft.sd.df, aes(status, M_cDC2)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors.sd) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="cDC2") +
  theme(legend.position="none") +
  ylim(0, 4.5) +
  stat_pvalue_manual(data=melted.stats[feature=="M_cDC2"],
                     label="p.symbol",
                     y.position=3,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "cDC2_box.eps"), height=2.5, width=2.5)

# Treg
ggplot(ft.sd.df, aes(status, T_CD4_T_Treg)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors.sd) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD4+ T cells", title="Treg") +
  theme(legend.position="none") +
  #ylim(0, 3.) +
  stat_pvalue_manual(data=melted.stats[feature=="T_CD4_T_Treg"],
                     label="p.symbol",
                     y.position=10,
                     step.increase=0.15,
                     size=10)
ggsave(paste0(pa, "Treg_box.eps"), height=2.5, width=2.5)

# Plasma cell
ggplot(ft.sd.df, aes(status, B_Plasma)) +
  geom_boxplot(aes(fill=status), outlier.shape=NA) +
  scale_fill_manual(values=status.colors.sd) +
  geom_quasirandom(width=0.2) +
  theme_bw() +
  labs(x=NULL, y="% of CD45+", title="Plasma cells") +
  theme(legend.position="none") +
  #ylim(0, 50) +
  stat_pvalue_manual(data=melted.stats[feature=="B_Plasma"],
                     label="p.symbol",
                     y.position=28,
                     step.increase=0.1,
                     size=10)
ggsave(paste0(pa, "Plasma_box.eps"), height=2.5, width=2.5)

### cDC1 Ki-67 vs CD64
ggplot(ft.sd.df[!status %in% c("C", "DF", "DWS")], aes(mean_CD64_M_cDC1, mean_Ki_67_M_cDC1, color=status)) +
  geom_point(size=2) +
  scale_color_manual(values=status.colors.sd) +
  theme_bw() +
  theme(legend.position="none", panel.grid.minor=element_blank()) +
  labs(x="Mean CD64", y="Mean Ki-67", title="cDC1")
ggsave(paste0(pa, "cDC1_biaxial.eps"), height=2.2, width=2)

#### Differential abundance bar

stats.temp <- melted.stats[group1=="DHF"]
pops <- levels(dat$population)
temp <- ft.sd.df[status %in% c("DHF", "OI"), lapply(.SD, median), .SDcols=pops, by=status] %>%
  melt(id.vars="status", variable.name="feature", value.name="percent") %>%
  dcast(feature~status, value.var="percent") %>%
  .[, dif:=log2(DHF/OI)] %>%
  .[, `:=`(DHF=NULL, OI=NULL)] %>%
  merge(stats.temp, by="feature", all.x=T) %>%
  .[, sig:=p.value<0.05 & abs(effect)>1] %>%
  .[order(dif)] %>%
  .[, feature:=factor(feature, feature)]

ggplot(temp, aes(feature, dif, fill=sig)) +
  geom_col() +
  theme_bw() +
  labs(x=NULL, y="Log2 %CD45+ (DHF/OI)") +
  scale_fill_manual(values=c("grey70", "#187A7A")) +
  theme(axis.text.x=element_text(hjust=1, angle=45),
        axis.text=element_text(size=14),
        title=element_text(size=16),
        legend.position="none",
        panel.grid.major.x=element_blank(),
        panel.grid.minor.x=element_blank(),
        plot.margin=unit(c(0,0,0,1), "cm"))
ggsave(paste0(pa, "abundance_bar.eps"), width=8, height=4)

### cDC stacked bar

features <- c("M_cDC1", "M_cDC2")
temp <- ft.sd.df[status %in% c("DHF", "OI"), c(features, "status", "patient"), with=F] %>%
  melt(id.vars=c("status", "patient"), variable.name="Population", value.name="P")

patient.order <- temp[, sum(P), by="patient"] %>%
  .[order(V1)] %>%
  .[, patient]

temp[, patient:=factor(patient, patient.order)]
labels <- temp[order(patient), .(status, patient)] %>%
  unique() %>%
  .[, status]

ggplot(temp, aes(patient, P, fill=Population)) +
  geom_col() +
  theme_bw() + 
  theme(axis.text.x=element_text(hjust=1, angle=45),
        panel.grid.minor=element_blank(),
        panel.grid.major.x=element_blank(),
        legend.position="none") +
  scale_x_discrete(labels=labels) +
  labs(x="Patient Status", y="% CD45+ cells")
ggsave(paste0(pa, "DC_proportions.eps"), width=5, height=2.5)

# Plasma isotype stacked bar

features <- paste0("B_Plasma_", c("IgM", "IgG", "IgA", "ND"))
temp <- ft.sd.df[status %in% c("DHF", "OI"), c(features, "status", "patient"), with=F] %>%
  melt(id.vars=c("status", "patient"), variable.name="Population", value.name="P")

patient.order <- temp[Population=="B_Plasma_IgM"] %>%
  .[order(P), patient]
temp[, patient:=factor(patient, patient.order)]
labels <- temp[order(patient), .(status, patient)] %>%
  unique() %>%
  .[, status]
temp[, Population:=substring(Population, 10)]
temp[, Population:=factor(Population, c("IgM", "IgG", "IgA", "ND"))]

ggplot(temp, aes(patient, P, fill=Population)) +
  geom_col() +
  theme_bw() + 
  scale_fill_manual(values=isotype.colors, drop=T) +
  theme(axis.text.x=element_text(hjust=1, angle=45),
        panel.grid.minor=element_blank(),
        panel.grid.major.x=element_blank(),
        legend.position="none") +
  scale_x_discrete(labels=labels) +
  labs(x="Patient Status", y="% Plasma cells")
ggsave(paste0(pa, "Plasma_isotypes.eps"), width=5, height=2.5)

## Supplement patient summary
temp <- ft.sd.df[!is.na(sd_type), .(sd_type, adult)]
ggplot(temp, aes(sd_type, fill=adult)) +
  geom_bar() +
  theme_bw() +
  labs(y="Patients", x="Status")
ggsave(paste0(pa, "sd_subtype_adult.eps"), height=2.5, width=2.5)


##### Figure 1 Illustrations #####

pa <- paste0(images.path, "figure_1/")
if (!dir.exists(pa)) dir.create(pa)

### Volcano

volcano.dt <- all.stats[, .(feature, df.sd.effect, df.sd.p.value)] %>%
  .[, significant:=abs(df.sd.effect)>0.5 & df.sd.p.value<0.05] %>%
  .[, df.sd.p.value:=-log10(df.sd.p.value)]
p.cutoff <- -log10(0.05)
effect.limits <-  max(abs(range(volcano.dt$df.sd.effect))) %>%
  c(-., .) %>%
  round()

ggplot(volcano.dt, aes(df.sd.effect, df.sd.p.value, color=significant)) +
  geom_point(size=1) +
  theme_bw() +
  scale_color_manual(values=c("grey70", "#187A7A")) +
  geom_hline(yintercept=p.cutoff, linetype="dashed") +
  geom_vline(xintercept=0.5, linetype="dashed") +
  geom_vline(xintercept=-0.5, linetype="dashed") +
  xlim(effect.limits) +
  labs(x=NULL, y=NULL) +
  theme(legend.position="none",
        panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())
ggsave(paste0(pa, "volcano.png"), width=3, height=3)

### Heatmap

temp <- feature.table[, setdiff(colnames(feature.table), factors), with=F] %>%
  .[, lapply(.SD, function(x) (x-min(x))/(max(x)-min(x)))] %>%
  as.matrix()
colnames(temp) <- NULL

pheatmap(temp,
        col=inferno(21),
        border_color=NA,
        treeheight_col=0,
        treeheight_row=0,
        legend=F,
        height=3,
        width=3,
        filename=paste0(pa, "example_heatmap.png"))

### Density plot

x <- data.table(a=rnorm(100, 0.7, sd=0.1))
ggplot(x, aes(a)) + 
  geom_density(fill="grey80") +
  geom_vline(xintercept=mean(x$a), linetype="dashed") +
  theme_bw() +
  theme(axis.text=element_blank(),
        axis.title=element_blank(),
        panel.grid=element_blank(),
        axis.ticks=element_blank())
ggsave(paste0(pa, "density.eps"), width=1.5, height=1.5)

temp <- data.table(a=c(5, 15, 30, 50, 15, 15, 25, 45),
                   b=rep(c("A", "B", "C","D"), 2),
                   c=c(rep("X", 4), rep("Y", 4)))

ggplot(temp, aes(x=c, y=a, fill=b)) +
  geom_col(position="stack") +
  theme_bw() +
  scale_fill_manual(values=rev(four.color.pal)) +
  theme(axis.text=element_blank(),
        axis.ticks=element_blank(),
        panel.grid=element_blank(),
        axis.title=element_blank(),
        legend.position="none")
ggsave(paste0(pa, "stacked_bar.eps"), width=1, height=1.5)

temp <- subsampleWrapper(dat, 100000)
temp[, density:=getDensity(CD3, TCRgd, 100)]
ggplot(temp, aes(CD3, TCRgd, color=density)) +
  geom_point(size=0.2) +
  scale_color_viridis() +
  theme_bw()